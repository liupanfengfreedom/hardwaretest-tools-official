<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黄金宏观精细化分析终端 | Hybrid Engine v2.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&display=swap');
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .btn-active { background-color: #fbbf24 !important; color: #020617 !important; border-color: #fbbf24 !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .chart-container { position: relative; height: 450px; cursor: crosshair; }
        .marker-line { position: absolute; top: 0; width: 1px; height: 100%; background-color: #fbbf24; pointer-events: none; z-index: 10; display: none; }
        .marker-handle { position: absolute; width: 12px; height: 30px; background-color: #fbbf24; border-radius: 3px; top: 50%; left: -6px; transform: translateY(-50%); }
        .marker-tooltip { position: absolute; background-color: rgba(2, 6, 23, 0.95); border: 1px solid #fbbf24; border-radius: 6px; padding: 8px 12px; font-size: 12px; font-family: 'JetBrains Mono'; color: #fbbf24; pointer-events: none; z-index: 11; white-space: nowrap; backdrop-filter: blur(4px); display: none; }
        @media (max-width: 768px) { .chart-container { height: 350px; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center">

    <div class="w-full max-w-6xl">
        <!-- 头部实时价格 -->
        <div id="price-header" class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 mb-6 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">全球金价实时终端 (CNY/G)</p>
                <div class="flex items-baseline gap-2">
                    <h1 id="cny-price" class="text-5xl md:text-6xl font-bold mono text-white">---.--</h1>
                    <span class="text-2xl text-slate-400">元/克</span>
                </div>
            </div>
            <div class="text-left md:text-right w-full md:w-auto">
                <div class="flex items-baseline gap-2 md:justify-end">
                    <p id="usd-ref" class="text-slate-400 mono text-xl font-bold">$----.--</p>
                    <span class="text-slate-400 text-sm">/盎司</span>
                </div>
                <p id="ex-rate" class="text-slate-600 text-xs mt-1 italic">正在同步外汇市场数据...</p>
                <div id="source-tag" class="inline-block mt-2 px-2 py-0.5 rounded border border-amber-500/30 text-[10px] text-amber-500/80 uppercase tracking-tighter">Realtime Hybrid Engine Active</div>
            </div>
        </div>

        <div class="bg-slate-900 rounded-3xl p-4 md:p-6 border border-slate-800">
            <!-- 时间跨度选择 -->
            <div class="overflow-x-auto no-scrollbar mb-6">
                <div class="flex flex-nowrap gap-2 p-1 bg-black/20 rounded-2xl w-max">
                    <!-- 新增：实时档位 (60分钟/1分钟采样) -->
                    <button onclick="changeRange('1m', 'LIVE', 60)" id="btn-LIVE" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all btn-active">实时</button>
                    <!-- 恢复：1天档位 (24小时/15分钟采样) -->
                    <button onclick="changeRange('15m', '1D', 96)" id="btn-1D" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1天</button>
                    
                    <button onclick="changeRange('4h', '1W', 42)" id="btn-1W" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1周</button>
                    <button onclick="changeRange('1d', '1M', 30)" id="btn-1M" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1月</button>
                    <button onclick="changeRange('1d', '6M', 180)" id="btn-6M" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">6月</button>
                    <button onclick="changeRange('1d', '1Y', 365)" id="btn-1Y" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1年</button>
                    <div class="w-[1px] h-4 bg-slate-800 self-center mx-1"></div>
                    <button onclick="handleMacro(5)" id="btn-5Y" class="px-3 py-2 rounded-xl text-xs font-bold text-amber-500/80 hover:bg-slate-800 transition-all">5年</button>
                    <button onclick="handleMacro(10)" id="btn-10Y" class="px-3 py-2 rounded-xl text-xs font-bold text-amber-500/80 hover:bg-slate-800 transition-all">10年</button>
                    <button onclick="handleMacro(30)" id="btn-30Y" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">30年</button>
                    <button onclick="handleMacro(100)" id="btn-ALL" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">全部(1972-)</button>
                </div>
            </div>

            <!-- 图表显示 -->
            <div class="chart-container" id="chart-wrapper">
                <canvas id="goldChart"></canvas>
                <div id="marker-line" class="marker-line"><div class="marker-handle"></div></div>
                <div id="marker-tooltip" class="marker-tooltip"></div>
                <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-slate-900/80 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-amber-500"></div>
                </div>
            </div>

            <!-- 说明信息 -->
            <div class="mt-6 pt-6 border-t border-slate-800 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-[11px] text-slate-500 space-y-2">
                    <p>● <span class="text-slate-300">实时源：</span>Binance PAXG/USDT (5s级同步)。</p>
                    <p>● <span class="text-slate-300">数据逻辑：</span>LIVE(1m), 1D(15m), 宏观(月/季采样)。</p>
                </div>
                <div class="text-[11px] text-slate-500 space-y-1 md:text-right">
                    <p>单位换算: <span class="mono">1 Troy Ounce = 31.1035 Grams</span></p>
                    <p id="data-status" class="italic text-amber-500/80">Terminal Live: High Fidelity Mode</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let goldChart;
        let usdRate = 7.23; 
        let currentLiveUSD = 2700; 
        const G_TO_OZ = 31.1035;
        let currentData = { labels: [], prices: [], dates: [] };
        let currentView = 'LIVE'; 

        const HISTORICAL_BENCHMARKS = [
            {y: 1972, p: 38}, {y: 1974.8, p: 180}, {y: 1976.7, p: 110}, {y: 1980.1, p: 850}, {y: 1982.5, p: 300},
            {y: 1985, p: 285}, {y: 1987.9, p: 480}, {y: 1990.5, p: 410}, {y: 1993, p: 330}, {y: 1996, p: 400},
            {y: 1999.7, p: 252}, {y: 2001.1, p: 260}, {y: 2003, p: 350}, {y: 2006.4, p: 720}, {y: 2008.3, p: 1020},
            {y: 2008.8, p: 700}, {y: 2011.7, p: 1910}, {y: 2013.5, p: 1200}, {y: 2015.9, p: 1050}, 
            {y: 2016.6, p: 1370}, {y: 2018.6, p: 1170}, {y: 2019.5, p: 1550}, {y: 2020.2, p: 1450}, 
            {y: 2020.6, p: 2070}, {y: 2021.2, p: 1680}, {y: 2022.2, p: 2050}, {y: 2022.8, p: 1620},
            {y: 2023.4, p: 2060}, {y: 2023.8, p: 1820}, {y: 2024.3, p: 2430}, {y: 2024.8, p: 2750}, {y: 2025.2, p: 2900}
        ];

        function initChart() {
            const ctx = document.getElementById('goldChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(251, 191, 36, 0.2)');
            gradient.addColorStop(1, 'rgba(2, 6, 23, 0)');

            goldChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ 
                    borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: gradient, data: [], tension: 0.1 
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { left: 0, right: 10, top: 30, bottom: 0 } },
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#475569', font: { size: 10 }, autoSkip: true, maxTicksLimit: 8 },
                        },
                        y: { 
                            position: 'left', 
                            grid: { color: '#1e293b' }, 
                            ticks: { color: '#475569', font: { family: 'JetBrains Mono' }, padding: 10 } 
                        }
                    }
                }
            });
            initMarkerLogic();
        }

        async function updateLivePrice() {
            try {
                const [exRes, goldRes] = await Promise.all([
                    fetch('https://open.er-api.com/v6/latest/USD'),
                    fetch('https://goldprice.starryring.com/api/v3/ticker/price?symbol=PAXGUSDT')
                ]);
                const exData = await exRes.json();
                const goldData = await goldRes.json();
                
                usdRate = exData.rates.CNY;
                currentLiveUSD = parseFloat(goldData.price);
                const cnyPrice = (currentLiveUSD * usdRate) / G_TO_OZ;

                document.getElementById('cny-price').innerText = cnyPrice.toFixed(2);
                document.getElementById('usd-ref').innerText = `$${currentLiveUSD.toFixed(2)}`;
                document.getElementById('ex-rate').innerText = `汇率: 1 USD = ${usdRate.toFixed(4)} CNY`;

                // 在 LIVE 或 1D 视图下实时修正最后一个点，确保最新数据立即可见
                if ((currentView === 'LIVE' || currentView === '1D') && currentData.prices.length > 0) {
                    const lastIdx = currentData.prices.length - 1;
                    currentData.prices[lastIdx] = cnyPrice;
                    currentData.dates[lastIdx] = new Date(); 
                    goldChart.data.datasets[0].data = currentData.prices;
                    goldChart.update('none');
                }
            } catch (e) {}
        }

        function initMarkerLogic() {
            const container = document.getElementById('chart-wrapper');
            const marker = document.getElementById('marker-line');
            const tooltip = document.getElementById('marker-tooltip');
            
            const handleMove = (e) => {
                if (!currentData.prices.length || !goldChart) return;
                const rect = container.getBoundingClientRect();
                const chartArea = goldChart.chartArea;
                if(!chartArea) return;

                const mouseX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const boundedX = Math.max(chartArea.left, Math.min(mouseX, chartArea.right));
                const helpers = goldChart.scales.x;
                const index = helpers.getValueForPixel(boundedX);
                const safeIndex = Math.min(Math.max(Math.round(index), 0), currentData.prices.length - 1);
                
                const snappedX = helpers.getPixelForValue(safeIndex);
                
                marker.style.display = 'block';
                marker.style.left = `${snappedX}px`;

                const price = currentData.prices[safeIndex];
                const date = currentData.dates[safeIndex];
                
                if (price && date) {
                    tooltip.style.display = 'block';
                    const tooltipWidth = 140;
                    tooltip.style.left = snappedX + tooltipWidth > rect.width - 20 ? `${snappedX - tooltipWidth - 15}px` : `${snappedX + 15}px`;
                    tooltip.style.top = '50px';

                    const needsTime = (currentView === 'LIVE' || currentView === '1D' || currentView === '1W');
                    const dateOptions = { month: 'short', day: 'numeric' };
                    if (currentView !== 'LIVE' && currentView !== '1D' && currentView !== '1W') dateOptions.year = 'numeric';
                    
                    const dateStr = date.toLocaleDateString('zh-CN', dateOptions);
                    const timeStr = needsTime ? date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
                    
                    tooltip.innerHTML = `
                        <div class="text-[10px] text-slate-400 mb-1">${dateStr} ${timeStr}</div>
                        <div class="font-bold text-lg text-amber-400">${price.toFixed(2)} <span class="text-[10px] text-white">CNY/G</span></div>
                    `;
                }
            };
            container.addEventListener('mousemove', handleMove);
            container.addEventListener('touchstart', handleMove);
        }

        async function changeRange(interval, rangeId, limit) {
            currentView = rangeId;
            updateBtnUI(`btn-${rangeId}`);
            showLoading(true);

            try {
                const res = await fetch(`https://goldprice.starryring.com/api/v3/klines?symbol=PAXGUSDT&interval=${interval}&limit=${limit}`);
                const klines = await res.json();
                
                currentData.prices = klines.map(k => (parseFloat(k[4]) * usdRate / G_TO_OZ));
                currentData.dates = klines.map(k => new Date(k[0]));
                currentData.labels = currentData.dates.map(d => {
                    if (rangeId === 'LIVE' || rangeId === '1D') return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    return `${d.getMonth()+1}/${d.getDate()}`;
                });

                renderChartData();
            } catch (e) { alert("数据加载失败"); }
            showLoading(false);
        }

        function handleMacro(years) {
            currentView = years >= 100 ? 'ALL' : years + 'Y';
            updateBtnUI(years > 50 ? 'btn-ALL' : `btn-${years}Y`);
            showLoading(true);

            const labels = [], prices = [], dates = [];
            const currentYear = new Date().getFullYear();
            let startYear = Math.max(1972, currentYear - years);

            for (let y = startYear; y <= currentYear; y++) {
                for (let m = 0; m < 12; m += (years <= 10 ? 1 : 3)) {
                    if (y === currentYear && m > new Date().getMonth()) break;
                    const priceUSD = interpolatePrice(y + (m/12));
                    prices.push((priceUSD * usdRate) / G_TO_OZ);
                    dates.push(new Date(y, m, 1));
                    labels.push(m === 0 ? `${y}` : '');
                }
            }
            currentData = { labels, prices, dates };
            renderChartData();
            showLoading(false);
        }

        function renderChartData() {
            goldChart.data.labels = currentData.labels;
            goldChart.data.datasets[0].data = currentData.prices;
            goldChart.update('none');
            
            setTimeout(() => {
                const helpers = goldChart.scales.x;
                const lastX = helpers.getPixelForValue(currentData.prices.length - 1);
                const marker = document.getElementById('marker-line');
                marker.style.display = 'block';
                marker.style.left = `${lastX}px`;
            }, 50);
        }

        function interpolatePrice(decimalYear) {
            for (let i = 0; i < HISTORICAL_BENCHMARKS.length - 1; i++) {
                const b1 = HISTORICAL_BENCHMARKS[i], b2 = HISTORICAL_BENCHMARKS[i+1];
                if (decimalYear >= b1.y && decimalYear <= b2.y) {
                    const ratio = (decimalYear - b1.y) / (b2.y - b1.y);
                    const f = (1 - Math.cos(ratio * Math.PI)) / 2;
                    return b1.p * (1 - f) + b2.p * f;
                }
            }
            return HISTORICAL_BENCHMARKS[HISTORICAL_BENCHMARKS.length-1].p;
        }

        function showLoading(show) { document.getElementById('chart-loading').classList.toggle('hidden', !show); }
        function updateBtnUI(id) {
            document.querySelectorAll('button').forEach(b => b.classList.remove('btn-active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('btn-active');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initChart();
            await updateLivePrice();
            // 默认初始化为实时视图
            changeRange('1m', 'LIVE', 60);
            setInterval(updateLivePrice, 20000); 
        });
    </script>
</body>
</html>