<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>黄金宏观精细化分析终端 | Hybrid Engine v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&display=swap');
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', system-ui, sans-serif; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .btn-active { background-color: #fbbf24 !important; color: #020617 !important; border-color: #fbbf24 !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .chart-container { 
            position: relative; 
            height: 450px; 
            cursor: crosshair; 
            /* 核心修复：防止移动端滑动时触发页面滚动，允许 JS 完全接管触摸 */
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .marker-line { position: absolute; top: 0; width: 1px; height: 100%; background-color: #fbbf24; pointer-events: none; z-index: 10; display: none; }
        .marker-handle { position: absolute; width: 12px; height: 30px; background-color: #fbbf24; border-radius: 3px; top: 50%; left: -6px; transform: translateY(-50%); }
        .marker-tooltip { position: absolute; background-color: rgba(2, 6, 23, 0.95); border: 1px solid #fbbf24; border-radius: 6px; padding: 8px 12px; font-size: 12px; font-family: 'JetBrains Mono'; color: #fbbf24; pointer-events: none; z-index: 11; white-space: nowrap; backdrop-filter: blur(4px); display: none; }
        
        @media (max-width: 768px) { .chart-container { height: 350px; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center">

    <div class="w-full max-w-6xl">
        <!-- 头部价格显示 -->
        <div id="price-header" class="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 mb-6 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">全球金价实时终端 (CNY/G)</p>
                <div class="flex items-baseline gap-2">
                    <h1 id="cny-price" class="text-5xl md:text-6xl font-bold mono text-white">---.--</h1>
                    <span class="text-2xl text-slate-400">元/克</span>
                </div>
            </div>
            <div class="text-left md:text-right w-full md:w-auto">
                <div class="flex items-baseline gap-2 md:justify-end">
                    <p id="usd-ref" class="text-slate-400 mono text-xl font-bold">$----.--</p>
                    <span class="text-slate-400 text-sm">/盎司</span>
                </div>
                <p id="ex-rate" class="text-slate-600 text-xs mt-1 italic">正在同步外汇市场数据...</p>
                <div id="source-tag" class="inline-block mt-2 px-2 py-0.5 rounded border border-amber-500/30 text-[10px] text-amber-500/80 uppercase tracking-tighter">Hybrid Engine Online</div>
            </div>
        </div>

        <!-- 主图表容器 -->
        <div class="bg-slate-900 rounded-3xl p-4 md:p-6 border border-slate-800">
            <!-- 时间维度选择 -->
            <div class="overflow-x-auto no-scrollbar mb-6">
                <div class="flex flex-nowrap gap-2 p-1 bg-black/20 rounded-2xl w-max">
                    <button onclick="changeRange('1m', 'LIVE', 60)" id="btn-LIVE" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">实时</button>
                    <button onclick="changeRange('15m', '1D', 96)" id="btn-1D" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1天</button>
                    <button onclick="changeRange('4h', '1W', 42)" id="btn-1W" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1周</button>
                    <button onclick="changeRange('1d', '1M', 30)" id="btn-1M" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1月</button>
                    <button onclick="changeRange('1d', '6M', 180)" id="btn-6M" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">6月</button>
                    <button onclick="changeRange('1d', '1Y', 365)" id="btn-1Y" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">1年</button>
                    <div class="w-[1px] h-4 bg-slate-800 self-center mx-1"></div>
                    <button onclick="handleMacro(5)" id="btn-5Y" class="px-3 py-2 rounded-xl text-xs font-bold text-amber-500/80 hover:bg-slate-800 transition-all">5年</button>
                    <button onclick="handleMacro(10)" id="btn-10Y" class="px-3 py-2 rounded-xl text-xs font-bold text-amber-500/80 hover:bg-slate-800 transition-all">10年</button>
                    <button onclick="handleMacro(30)" id="btn-30Y" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">30年</button>
                    <button onclick="handleMacro(100)" id="btn-ALL" class="px-3 py-2 rounded-xl text-xs font-bold text-slate-400 hover:bg-slate-800 transition-all">全部</button>
                </div>
            </div>

            <div class="chart-container" id="chart-wrapper">
                <canvas id="goldChart"></canvas>
                <div id="marker-line" class="marker-line"><div class="marker-handle"></div></div>
                <div id="marker-tooltip" class="marker-tooltip"></div>
                <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-slate-900/80 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-amber-500"></div>
                </div>
            </div>

            <!-- 底部信息 -->
            <div class="mt-6 pt-6 border-t border-slate-800 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-[11px] text-slate-500 space-y-2">
                    <p>● <span class="text-slate-300">交互说明：</span>在图表上左右滑动查看历史价格，数据秒级刷新。</p>
                </div>
                <div class="text-[11px] text-slate-500 space-y-1 md:text-right">
                    <p>单位换算: <span class="mono">1 Troy Ounce = 31.1035 Grams</span></p>
                    <div class="flex items-center md:justify-end gap-2">
                        <span id="refresh-timer" class="px-2 py-0.5 rounded bg-amber-500/10 text-amber-500 font-bold mono">--s</span>
                        <p id="data-status" class="italic text-slate-600">Terminal Ready</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let goldChart;
        let usdRate = 7.23; 
        let currentLiveUSD = 2700; 
        const G_TO_OZ = 31.1035;
        let currentData = { labels: [], prices: [], dates: [] };
        let currentView = 'LIVE'; 
        let nextRefreshTime = Date.now() + 5000;
        let currentInterval = '1m';
        let currentLimit = 60;
        let isRefreshing = false;
        let lastSelectedIndex = -1;

        const HISTORICAL_BENCHMARKS = [
            {y: 1972, p: 38}, {y: 1974.8, p: 180}, {y: 1976.7, p: 110}, {y: 1980.1, p: 850}, {y: 1982.5, p: 300},
            {y: 1985, p: 285}, {y: 1987.9, p: 480}, {y: 1990.5, p: 410}, {y: 1993, p: 330}, {y: 1996, p: 400},
            {y: 1999.7, p: 252}, {y: 2001.1, p: 260}, {y: 2003, p: 350}, {y: 2006.4, p: 720}, {y: 2008.3, p: 1020},
            {y: 2008.8, p: 700}, {y: 2011.7, p: 1910}, {y: 2013.5, p: 1200}, {y: 2015.9, p: 1050}, 
            {y: 2016.6, p: 1370}, {y: 2018.6, p: 1170}, {y: 2019.5, p: 1550}, {y: 2020.2, p: 1450}, 
            {y: 2020.6, p: 2070}, {y: 2021.2, p: 1680}, {y: 2022.2, p: 2050}, {y: 2022.8, p: 1620},
            {y: 2023.4, p: 2060}, {y: 2023.8, p: 1820}, {y: 2024.3, p: 2430}, {y: 2024.8, p: 2750}, {y: 2025.2, p: 2900}
        ];

        function initChart() {
            const ctx = document.getElementById('goldChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(251, 191, 36, 0.2)');
            gradient.addColorStop(1, 'rgba(2, 6, 23, 0)');

            goldChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ 
                    borderColor: '#fbbf24', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: gradient, data: [], tension: 0.1 
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { left: 0, right: 50, top: 30, bottom: 0 } },
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 10 }, autoSkip: true, maxTicksLimit: 8 } },
                        y: { position: 'right', grid: { color: '#1e293b' }, ticks: { color: '#475569', font: { family: 'JetBrains Mono' }, padding: 10 } }
                    }
                }
            });
            initMarkerLogic();
        }

        // 修改游标逻辑，增加对 touchmove 的支持
        function initMarkerLogic() {
            const container = document.getElementById('chart-wrapper');
            
            const handleMove = (e) => {
                if (!currentData.prices.length || !goldChart) return;
                
                const rect = container.getBoundingClientRect();
                const chartArea = goldChart.chartArea;
                if (!chartArea) return;

                // 获取 X 坐标（兼容触摸和鼠标）
                let clientX;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    // 如果正在滑动，阻止页面默认滚动行为
                    if (e.type === 'touchmove' && e.cancelable) e.preventDefault();
                } else {
                    clientX = e.clientX;
                }

                const mouseX = clientX - rect.left;
                
                // 限制范围
                const boundedX = Math.max(chartArea.left, Math.min(mouseX, chartArea.right));
                const helpers = goldChart.scales.x;
                
                // 计算数据索引
                const index = Math.min(Math.max(Math.round(helpers.getValueForPixel(boundedX)), 0), currentData.prices.length - 1);
                
                if (index !== lastSelectedIndex) {
                    lastSelectedIndex = index;
                    updateTooltipContent(index);
                }
            };

            // 监听鼠标移动
            container.addEventListener('mousemove', handleMove);
            // 关键：增加 touchmove 监听，并设置 passive: false 以允许 preventDefault
            container.addEventListener('touchstart', handleMove, { passive: false });
            container.addEventListener('touchmove', handleMove, { passive: false });
        }

        function updateTooltipContent(index) {
            if (index < 0 || index >= currentData.prices.length) return;
            const tooltip = document.getElementById('marker-tooltip');
            const marker = document.getElementById('marker-line');
            const helpers = goldChart.scales.x;
            const price = currentData.prices[index];
            const date = currentData.dates[index];
            
            if (!price || !date) return;

            const snappedX = helpers.getPixelForValue(index);
            const rect = document.getElementById('chart-wrapper').getBoundingClientRect();
            
            marker.style.display = 'block';
            marker.style.left = `${snappedX}px`;
            tooltip.style.display = 'block';

            const tooltipWidth = 140;
            // 边界检查：防止 Tooltip 超出右侧
            tooltip.style.left = snappedX + tooltipWidth > rect.width - 60 ? `${snappedX - tooltipWidth - 15}px` : `${snappedX + 15}px`;
            tooltip.style.top = '50px';

            const needsTime = (['LIVE', '1D', '1W'].includes(currentView));
            const dateOptions = { month: 'short', day: 'numeric' };
            if (!needsTime) dateOptions.year = 'numeric';
            
            const dateStr = date.toLocaleDateString('zh-CN', dateOptions);
            const timeStr = needsTime ? date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
            
            tooltip.innerHTML = `
                <div class="text-[10px] text-slate-400 mb-1">${dateStr} ${timeStr}</div>
                <div class="font-bold text-lg text-amber-400">${price.toFixed(2)} <span class="text-[10px] text-white">CNY/G</span></div>
            `;
        }

        async function updateLivePrice() {
            try {
                const exRes = await fetch('https://open.er-api.com/v6/latest/USD');
                const exData = await exRes.json();
                usdRate = exData.rates.CNY;

                const goldRes = await fetch('https://goldprice.starryring.com/api/v3/ticker/price?symbol=PAXGUSDT');
                const goldJson = await goldRes.json();
                
                currentLiveUSD = parseFloat(goldJson.data.price);
                nextRefreshTime = goldJson.nextUpdateAt;

                const cnyPrice = (currentLiveUSD * usdRate) / G_TO_OZ;
                document.getElementById('cny-price').innerText = cnyPrice.toFixed(2);
                document.getElementById('usd-ref').innerText = `$${currentLiveUSD.toFixed(2)}`;
                document.getElementById('ex-rate').innerText = `汇率: 1 USD = ${usdRate.toFixed(4)} CNY`;

                if (['LIVE', '1D'].includes(currentView) && currentData.prices.length > 0) {
                    const lastIdx = currentData.prices.length - 1;
                    currentData.prices[lastIdx] = cnyPrice;
                    currentData.dates[lastIdx] = new Date(); 
                    
                    goldChart.data.datasets[0].data = currentData.prices;
                    goldChart.update('none');
                    
                    if (lastSelectedIndex === lastIdx) {
                        updateTooltipContent(lastIdx);
                    }
                }
            } catch (e) {
                nextRefreshTime = Date.now() + 5000;
            }
        }

        async function changeRange(interval, rangeId, limit) {
            if (isRefreshing) return;
            currentView = rangeId;
            currentInterval = interval;
            currentLimit = limit;
            updateBtnUI(`btn-${rangeId}`);
            showLoading(true);

            try {
                const res = await fetch(`https://goldprice.starryring.com/api/v3/klines?symbol=PAXGUSDT&interval=${interval}&limit=${limit}`);
                const json = await res.json();
                nextRefreshTime = json.nextUpdateAt;
                const klines = json.data;

                currentData.prices = klines.map(k => (parseFloat(k[4]) * usdRate / G_TO_OZ));
                currentData.dates = klines.map(k => new Date(k[0]));
                currentData.labels = currentData.dates.map(d => {
                    if (rangeId === 'LIVE' || rangeId === '1D') return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    return `${d.getMonth()+1}/${d.getDate()}`;
                });

                renderChartData();
            } catch (e) {
                nextRefreshTime = Date.now() + 5000;
            }
            showLoading(false);
        }

        function handleMacro(years) {
            currentView = years >= 100 ? 'ALL' : years + 'Y';
            updateBtnUI(years > 50 ? 'btn-ALL' : `btn-${years}Y`);
            nextRefreshTime = Date.now() + 3600000;

            const labels = [], prices = [], dates = [];
            const currentYear = new Date().getFullYear();
            let startYear = Math.max(1972, currentYear - years);

            for (let y = startYear; y <= currentYear; y++) {
                for (let m = 0; m < 12; m += (years <= 10 ? 1 : 3)) {
                    if (y === currentYear && m > new Date().getMonth()) break;
                    const priceUSD = interpolatePrice(y + (m/12));
                    prices.push((priceUSD * usdRate) / G_TO_OZ);
                    dates.push(new Date(y, m, 1));
                    labels.push(m === 0 ? `${y}` : '');
                }
            }
            currentData = { labels, prices, dates };
            renderChartData();
        }

        function renderChartData() {
            goldChart.data.labels = currentData.labels;
            goldChart.data.datasets[0].data = currentData.prices;
            goldChart.update('none');
            
            const lastIdx = currentData.prices.length - 1;
            lastSelectedIndex = lastIdx;
            setTimeout(() => updateTooltipContent(lastIdx), 50);
        }

        async function refreshLoop() {
            const timerEl = document.getElementById('refresh-timer');
            const statusEl = document.getElementById('data-status');
            if (isRefreshing) { setTimeout(refreshLoop, 1000); return; }

            const remain = Math.ceil((nextRefreshTime - Date.now()) / 1000);
            if (remain <= 0) {
                isRefreshing = true;
                timerEl.innerText = "0s";
                statusEl.innerText = "正在更新...";
                statusEl.classList.add('text-amber-500');
                
                try {
                    await updateLivePrice();
                    if (['LIVE', '1D', '1W', '1M', '6M', '1Y'].includes(currentView)) {
                        const res = await fetch(`https://goldprice.starryring.com/api/v3/klines?symbol=PAXGUSDT&interval=${currentInterval}&limit=${currentLimit}`);
                        const json = await res.json();
                        nextRefreshTime = json.nextUpdateAt;
                        
                        currentData.prices = json.data.map(k => (parseFloat(k[4]) * usdRate / G_TO_OZ));
                        currentData.dates = json.data.map(k => new Date(k[0]));
                        
                        goldChart.data.datasets[0].data = currentData.prices;
                        goldChart.update('none');
                        
                        if (lastSelectedIndex !== -1) {
                            updateTooltipContent(lastSelectedIndex);
                        }
                    }
                } catch (e) {
                    nextRefreshTime = Date.now() + 5000;
                } finally {
                    isRefreshing = false;
                }
            } else {
                timerEl.innerText = `${remain}s`;
                statusEl.innerText = "数据已同步";
                statusEl.classList.remove('text-amber-500');
            }
            setTimeout(refreshLoop, 1000);
        }

        function interpolatePrice(decimalYear) {
            for (let i = 0; i < HISTORICAL_BENCHMARKS.length - 1; i++) {
                const b1 = HISTORICAL_BENCHMARKS[i], b2 = HISTORICAL_BENCHMARKS[i+1];
                if (decimalYear >= b1.y && decimalYear <= b2.y) {
                    const ratio = (decimalYear - b1.y) / (b2.y - b1.y);
                    const f = (1 - Math.cos(ratio * Math.PI)) / 2;
                    return b1.p * (1 - f) + b2.p * f;
                }
            }
            return HISTORICAL_BENCHMARKS[HISTORICAL_BENCHMARKS.length-1].p;
        }

        function showLoading(show) { document.getElementById('chart-loading').classList.toggle('hidden', !show); }
        function updateBtnUI(id) {
            document.querySelectorAll('button').forEach(b => b.classList.remove('btn-active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('btn-active');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            initChart();
            await updateLivePrice();
            await changeRange('1m', 'LIVE', 60);
            refreshLoop(); 
        });
    </script>
</body>
</html>