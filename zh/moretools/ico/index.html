<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon Studio Pro - é›†æˆ ICO è½¬æ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥æ ¸å¿ƒåº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- æ›¿æ¢ä¸ºæ­£ç¡®çš„ ICO è½¬æ¢åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/icojs@1.0.3/dist/ico.min.js"></script>
    
    <style>
        .phone-mockup { width: 260px; height: 530px; border: 8px solid #222; border-radius: 40px; position: relative; background-size: cover; background-position: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow: hidden; flex-shrink: 0; }
        .dynamic-island { width: 80px; height: 25px; background: #000; border-radius: 20px; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .punch-hole { width: 12px; height: 12px; background: #222; border-radius: 50%; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 60px 20px; }
        .app-item { display: flex; flex-direction: column; align-items: center; }
        .app-icon-placeholder { width: 45px; height: 45px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border-radius: 10px; margin-bottom: 4px; }
        .ios-icon { border-radius: 22%; }
        .android-icon { border-radius: 50%; }
        .app-label { color: white; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .bg-ios { background-image: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .bg-android { background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&q=80&w=400'); }
    </style>
</head>
<body class="bg-slate-900 min-h-screen text-slate-200 font-sans">

    <div class="max-w-7xl mx-auto px-6 py-10">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1 class="text-2xl font-black bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent italic">FAVICON STUDIO</h1>
                <p class="text-slate-400 text-sm">å·²é›†æˆå¤šåˆ†è¾¨ç‡ .ICO å¯¼å‡ºåŠŸèƒ½</p>
            </div>
            <div id="download-area" class="hidden">
                <button id="downloadZipBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-blue-900/40 transition-all flex items-center scale-105">
                    <span class="mr-2">ğŸ“¥</span> ä¸‹è½½å…¨å¥—å›¾æ ‡åŒ… (.zip)
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-10">
            <!-- å·¦ä¾§æ“ä½œåŒº -->
            <div class="xl:col-span-4 space-y-6">
                <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-blue-400">
                        <span class="mr-2">ğŸ“¸</span> 1. ä¸Šä¼ å›¾ç‰‡
                    </h2>
                    <div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded-2xl p-8 text-center hover:border-blue-500 transition-colors cursor-pointer mb-4 bg-slate-900/50">
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <p class="text-sm text-slate-400">ç‚¹å‡»æˆ–æ‹–æ‹½åŸå›¾</p>
                    </div>
                    <div id="editor-container" class="hidden overflow-hidden rounded-xl">
                        <img id="cropperImage" src="">
                        <button id="generateBtn" class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold py-4 transition-all">
                            ç”Ÿæˆæ‰€æœ‰å°ºå¯¸ (å« ICO)
                        </button>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">åŒ…å«çš„æ–‡ä»¶è§„æ ¼</h3>
                    <ul class="text-sm space-y-2 text-slate-300">
                        <li class="flex items-center text-emerald-400">âœ“ favicon.ico (16/32/48)</li>
                        <li class="flex items-center">âœ“ favicon-16x16 / 32x32.png</li>
                        <li class="flex items-center">âœ“ favicon-48x48 / 96x96.png</li>
                        <li class="flex items-center">âœ“ apple-touch-icon (180x180)</li>
                        <li class="flex items-center">âœ“ android-chrome (192/512)</li>
                    </ul>
                </div>
            </div>

            <!-- å³ä¾§æ‹ŸçœŸé¢„è§ˆ -->
            <div class="xl:col-span-8">
                <div class="bg-slate-800/50 border border-slate-700 rounded-[40px] p-8 overflow-x-auto">
                    <div class="flex flex-row gap-10 items-start justify-center min-w-[850px]">
                        <!-- iOS -->
                        <div class="flex flex-col items-center">
                            <div class="phone-mockup bg-ios">
                                <div class="dynamic-island"></div>
                                <div class="app-grid">
                                    <div class="app-item">
                                        <img id="prev-ios" class="w-[45px] h-[45px] ios-icon shadow-lg hidden">
                                        <div id="ios-placeholder" class="app-icon-placeholder ios-icon"></div>
                                        <span class="app-label">YourApp</span>
                                    </div>
                                    <script>for(let i=0; i<7; i++) document.write('<div class="app-item"><div class="app-icon-placeholder ios-icon"></div><span class="app-label">App</span></div>')</script>
                                </div>
                            </div>
                            <p class="mt-4 text-xs font-bold text-slate-500">iOS æ¡Œé¢ (180px)</p>
                        </div>

                        <!-- Android -->
                        <div class="flex flex-col items-center">
                            <div class="phone-mockup bg-android">
                                <div class="punch-hole"></div>
                                <div class="app-grid">
                                    <div class="app-item">
                                        <img id="prev-android" class="w-[45px] h-[45px] android-icon shadow-lg hidden">
                                        <div id="android-placeholder" class="app-icon-placeholder android-icon"></div>
                                        <span class="app-label">YourApp</span>
                                    </div>
                                    <script>for(let i=0; i<7; i++) document.write('<div class="app-item"><div class="app-icon-placeholder android-icon"></div><span class="app-label">App</span></div>')</script>
                                </div>
                            </div>
                            <p class="mt-4 text-xs font-bold text-slate-500">Android æ¡Œé¢ (åœ†å½¢)</p>
                        </div>

                        <!-- æœç´¢ä¸æ ‡ç­¾ -->
                        <div class="space-y-6">
                            <div class="w-[300px] bg-white rounded-2xl p-4 text-slate-900 shadow-xl">
                                <div class="flex items-center mb-2">
                                    <div class="w-6 h-6 bg-slate-100 rounded-full flex items-center justify-center mr-2 overflow-hidden">
                                        <img id="prev-search" class="w-4 h-4 hidden">
                                    </div>
                                    <span class="text-[10px] text-slate-500 truncate">https://your-site.com</span>
                                </div>
                                <div class="text-blue-700 text-sm font-medium mb-1">å®Œç¾çš„ç½‘é¡µæ ‡é¢˜é¢„è§ˆ</div>
                                <div class="text-[10px] text-slate-400 line-clamp-1">è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿ Google æœç´¢ç»“æœçš„æ˜¾ç¤º...</div>
                            </div>

                            <div class="w-[300px] bg-slate-700 rounded-xl p-4 border border-slate-600">
                                <p class="text-[10px] text-slate-500 mb-2 uppercase">Browser Tab</p>
                                <div class="bg-slate-800 rounded-lg p-2 flex items-center border border-slate-600">
                                    <img id="prev-tab" class="w-4 h-4 mr-2 hidden">
                                    <div class="w-20 h-2 bg-slate-700 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const dropZone = document.getElementById('drop-zone');
        const editorContainer = document.getElementById('editor-container');
        const cropperImage = document.getElementById('cropperImage');
        const generateBtn = document.getElementById('generateBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const downloadArea = document.getElementById('download-area');

        let cropper = null;
        let generatedBlobs = {};

        // è¯¦ç»†é…ç½®ï¼šå“ªäº› PNG å°ºå¯¸éœ€è¦ç”Ÿæˆï¼Œå“ªäº›è¦æ‰“åŒ…è¿› ICO
        const configs = [
            { name: 'favicon-16x16.png', size: 16, previews: ['prev-search', 'prev-tab'], inIco: true },
            { name: 'favicon-32x32.png', size: 32, inIco: true },
            { name: 'favicon-48x48.png', size: 48, inIco: true },
            { name: 'favicon-96x96.png', size: 96 },
            { name: 'apple-touch-icon.png', size: 180, previews: ['prev-ios'] },
            { name: 'android-chrome-192x192.png', size: 192, previews: ['prev-android'] },
            { name: 'android-chrome-512x512.png', size: 512 }
        ];

        dropZone.onclick = () => imageInput.click();
        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                cropperImage.src = ev.target.result;
                dropZone.classList.add('hidden');
                editorContainer.classList.remove('hidden');
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropperImage, { aspectRatio: 1, viewMode: 1 });
            };
            reader.readAsDataURL(file);
        };

        // å°† Blob è½¬æ¢ä¸º ArrayBuffer
        function blobToArrayBuffer(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsArrayBuffer(blob);
            });
        }

        generateBtn.onclick = async () => {
            generateBtn.disabled = true;
            generateBtn.innerText = "æ­£åœ¨å¤„ç†ä¸­...";
            
            const canvas = cropper.getCroppedCanvas({ width: 1024, height: 1024 });
            const icoSources = [];

            for (const config of configs) {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = config.size;
                tempCanvas.height = config.size;
                const ctx = tempCanvas.getContext('2d');
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(canvas, 0, 0, config.size, config.size);

                // å¯¼å‡º PNG Blob
                const blob = await new Promise(r => tempCanvas.toBlob(r, 'image/png'));
                generatedBlobs[config.name] = blob;

                // å¦‚æœå±äº ICO ç»„æˆéƒ¨åˆ†ï¼Œå­˜å…¥æ•°ç»„
                if (config.inIco) {
                    icoSources.push({
                        buffer: await blobToArrayBuffer(blob),
                        width: config.size,
                        height: config.size
                    });
                }

                // æ›´æ–° UI é¢„è§ˆ
                if (config.previews) {
                    const url = URL.createObjectURL(blob);
                    config.previews.forEach(id => {
                        const img = document.getElementById(id);
                        img.src = url;
                        img.classList.remove('hidden');
                        const placeholder = document.getElementById(id.replace('prev-', '') + '-placeholder');
                        if(placeholder) placeholder.classList.add('hidden');
                    });
                }
            }

            // --- æ ¸å¿ƒï¼šç”Ÿæˆ .ICO æ–‡ä»¶ ---
            try {
                // ä½¿ç”¨ icojs ç”Ÿæˆ ICO æ–‡ä»¶
                const ico = new Ico();
                
                // æ·»åŠ å¤šä¸ªå°ºå¯¸çš„å›¾ç‰‡åˆ° ICO
                for (const source of icoSources) {
                    ico.addFromBuffer(source.buffer);
                }
                
                // ç”Ÿæˆ ICO Blob
                const icoBlob = ico.toBlob();
                generatedBlobs['favicon.ico'] = icoBlob;
                
                console.log("ICO ç”ŸæˆæˆåŠŸï¼Œå¤§å°:", icoBlob.size, "bytes");
            } catch (err) {
                console.error("ICO è½¬æ¢å¤±è´¥:", err);
                // å¦‚æœ icojs å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Canvas ç”Ÿæˆä¸€ä¸ªç®€å•çš„ 16x16 ICO ä½œä¸ºå¤‡ç”¨
                try {
                    const icoCanvas = document.createElement('canvas');
                    icoCanvas.width = 16;
                    icoCanvas.height = 16;
                    const icoCtx = icoCanvas.getContext('2d');
                    icoCtx.drawImage(canvas, 0, 0, 16, 16);
                    
                    // åˆ›å»ºä¸€ä¸ªç®€å•çš„ ICO æ–‡ä»¶å¤´
                    const icoHeader = new Uint8Array([
                        0, 0, 1, 0, 1, 0, 16, 16, 0, 0, 0, 0, 0, 0, 40, 0, 0, 0, 16, 0, 0, 0
                    ]);
                    
                    // è·å– PNG æ•°æ®
                    const pngBlob = await new Promise(r => icoCanvas.toBlob(r, 'image/png'));
                    const pngBuffer = await blobToArrayBuffer(pngBlob);
                    
                    // åˆå¹¶ ICO æ–‡ä»¶
                    const totalLength = icoHeader.length + pngBuffer.byteLength;
                    const icoArray = new Uint8Array(totalLength);
                    icoArray.set(icoHeader, 0);
                    icoArray.set(new Uint8Array(pngBuffer), icoHeader.length);
                    
                    const icoBlob = new Blob([icoArray], { type: 'image/x-icon' });
                    generatedBlobs['favicon.ico'] = icoBlob;
                    console.log("ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆç”Ÿæˆ ICO");
                } catch (backupErr) {
                    console.error("å¤‡ç”¨ ICO ç”Ÿæˆä¹Ÿå¤±è´¥:", backupErr);
                    alert("ICO ç”Ÿæˆå¤±è´¥ï¼Œä½† PNG æ–‡ä»¶å·²ç”Ÿæˆã€‚è¯·å°è¯•é‡æ–°ä¸Šä¼ å›¾ç‰‡æˆ–ä½¿ç”¨å…¶ä»–å·¥å…·è½¬æ¢ ICOã€‚");
                }
            }

            generateBtn.disabled = false;
            generateBtn.innerText = "é‡æ–°ç”Ÿæˆ";
            downloadArea.classList.remove('hidden');
            downloadArea.scrollIntoView({ behavior: 'smooth' });
        };

        downloadZipBtn.onclick = async () => {
            const zip = new JSZip();
            // æ”¾å…¥æ‰€æœ‰ç”Ÿæˆçš„ PNG å’Œ ICO
            for (const name in generatedBlobs) {
                zip.file(name, generatedBlobs[name]);
            }
            
            // æ”¾å…¥ PWA é…ç½®æ–‡ä»¶
            const manifest = {
                name: "My Website",
                short_name: "Web",
                icons: [
                    { src: "/android-chrome-192x192.png", sizes: "192x192", type: "image/png" },
                    { src: "/android-chrome-512x512.png", sizes: "512x512", type: "image/png" }
                ],
                display: "standalone"
            };
            zip.file("site.webmanifest", JSON.stringify(manifest, null, 2));

            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = "favicon_kit_pro.zip";
            link.click();
        };

        // æ·»åŠ æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500');
            dropZone.classList.remove('border-slate-600');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            dropZone.classList.add('border-slate-600');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            dropZone.classList.add('border-slate-600');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    cropperImage.src = ev.target.result;
                    dropZone.classList.add('hidden');
                    editorContainer.classList.remove('hidden');
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(cropperImage, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>