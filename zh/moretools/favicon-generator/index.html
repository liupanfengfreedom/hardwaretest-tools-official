<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon Studio Pro - æµè§ˆå™¨åŸç”Ÿ ICO è½¬æ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        .phone-mockup { width: 260px; height: 530px; border: 8px solid #222; border-radius: 40px; position: relative; background-size: cover; background-position: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow: hidden; flex-shrink: 0; }
        .dynamic-island { width: 80px; height: 25px; background: #000; border-radius: 20px; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .punch-hole { width: 12px; height: 12px; background: #222; border-radius: 50%; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 10; }
        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 60px 20px; }
        .app-item { display: flex; flex-direction: column; align-items: center; }
        .app-icon-placeholder { width: 45px; height: 45px; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); border-radius: 10px; margin-bottom: 4px; }
        .ios-icon { border-radius: 22%; }
        .android-icon { border-radius: 50%; }
        .app-label { color: white; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .bg-ios { background-image: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .bg-android { background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&q=80&w=400'); }
        
        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-900 min-h-screen text-slate-200 font-sans">

    <div class="max-w-7xl mx-auto px-6 py-10">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1 class="text-2xl font-black bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent italic">FAVICON STUDIO</h1>
                <p class="text-slate-400 text-sm">æµè§ˆå™¨æœ¬åœ°ç”Ÿæˆ .ICOï¼Œæ— éœ€æœåŠ¡å™¨</p>
            </div>
            <div id="download-area" class="hidden">
                <button id="downloadZipBtn" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg shadow-blue-900/40 transition-all flex items-center scale-105">
                    <span class="mr-2">ğŸ“¥</span> ä¸‹è½½å…¨å¥—å›¾æ ‡åŒ… (.zip)
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-10">
            <!-- å·¦ä¾§æ“ä½œåŒº -->
            <div class="xl:col-span-4 space-y-6">
                <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-blue-400">
                        <span class="mr-2">ğŸ“¸</span> 1. ä¸Šä¼ å›¾ç‰‡
                    </h2>
                    <div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded-2xl p-8 text-center hover:border-blue-500 transition-colors cursor-pointer mb-4 bg-slate-900/50">
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <p class="text-sm text-slate-400">ç‚¹å‡»æˆ–æ‹–æ‹½åŸå›¾</p>
                        <p class="text-xs text-slate-500 mt-2">æ”¯æŒ JPG, PNG, WebP</p>
                    </div>
                    <div id="editor-container" class="hidden">
                        <div class="mb-4 overflow-hidden rounded-xl bg-slate-700 min-h-[200px]">
                            <img id="cropperImage" src="" style="max-width: 100%;">
                        </div>
                        <button id="generateBtn" class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-bold py-4 rounded-xl transition-all flex justify-center items-center">
                            <span>ç”Ÿæˆæ‰€æœ‰å°ºå¯¸ (å« ICO)</span>
                        </button>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">åŒ…å«çš„æ–‡ä»¶è§„æ ¼</h3>
                    <ul class="text-sm space-y-2 text-slate-300">
                        <li class="flex items-center text-emerald-400">âœ“ favicon.ico (å¤šåˆ†è¾¨ç‡é›†)</li>
                        <li class="flex items-center">âœ“ 16/32/48/96 PNG å›¾æ ‡</li>
                        <li class="flex items-center">âœ“ Apple Touch Icon (180x180)</li>
                        <li class="flex items-center">âœ“ Android Chrome (192/512)</li>
                    </ul>
                </div>
            </div>

            <!-- å³ä¾§é¢„è§ˆåŒº -->
            <div class="xl:col-span-8">
                <div class="bg-slate-800/50 border border-slate-700 rounded-[40px] p-8 overflow-x-auto">
                    <div class="flex flex-row gap-10 items-start justify-center min-w-[850px]">
                        <!-- iOS Mockup -->
                        <div class="flex flex-col items-center">
                            <div class="phone-mockup bg-ios">
                                <div class="dynamic-island"></div>
                                <div class="app-grid" id="ios-grid">
                                    <div class="app-item">
                                        <img id="prev-ios" class="w-[45px] h-[45px] ios-icon shadow-lg hidden">
                                        <div id="ios-placeholder" class="app-icon-placeholder ios-icon"></div>
                                        <span class="app-label">YourApp</span>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-4 text-xs font-bold text-slate-500">iOS æ¡Œé¢ (180px)</p>
                        </div>

                        <!-- Android Mockup -->
                        <div class="flex flex-col items-center">
                            <div class="phone-mockup bg-android">
                                <div class="punch-hole"></div>
                                <div class="app-grid">
                                    <div class="app-item">
                                        <img id="prev-android" class="w-[45px] h-[45px] android-icon shadow-lg hidden">
                                        <div id="android-placeholder" class="app-icon-placeholder android-icon"></div>
                                        <span class="app-label">YourApp</span>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-4 text-xs font-bold text-slate-500">Android æ¡Œé¢</p>
                        </div>

                        <!-- Web Preview -->
                        <div class="space-y-6">
                            <div class="w-[300px] bg-white rounded-2xl p-4 text-slate-900 shadow-xl">
                                <div class="flex items-center mb-2">
                                    <img id="prev-search" class="w-4 h-4 mr-2 hidden">
                                    <span class="text-[10px] text-slate-500 truncate">https://your-site.com</span>
                                </div>
                                <div class="text-blue-700 text-sm font-medium">æœç´¢ç»“æœé¢„è§ˆ</div>
                            </div>

                            <div class="w-[300px] bg-slate-700 rounded-xl p-4 border border-slate-600">
                                <p class="text-[10px] text-slate-500 mb-2 uppercase">æµè§ˆå™¨æ ‡ç­¾é¡µ</p>
                                <div class="bg-slate-800 rounded-lg p-2 flex items-center">
                                    <img id="prev-tab" class="w-4 h-4 mr-2 hidden">
                                    <div class="w-20 h-2 bg-slate-700 rounded"></div>
                                </div>
                            </div>

                            <div class="w-[300px] bg-slate-700 rounded-xl p-4 border border-slate-600">
                                <p class="text-[10px] text-slate-500 mb-2 uppercase">ICO å¤šå°ºå¯¸é›†</p>
                                <div class="flex space-x-4">
                                    <img id="prev-ico-16" class="w-4 h-4 hidden bg-slate-800">
                                    <img id="prev-ico-32" class="w-8 h-8 hidden bg-slate-800">
                                    <img id="prev-ico-48" class="w-12 h-12 hidden bg-slate-800">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * æ ¸å¿ƒé€»è¾‘ï¼šåœ¨æµè§ˆå™¨ç«¯æ‰‹åŠ¨æ„å»º ICO æ–‡ä»¶æ ¼å¼
         * ICO åŒ…å«ï¼šæ–‡ä»¶å¤´(6å­—èŠ‚) + ç›®å½•é¡¹(æ¯ä¸ª16å­—èŠ‚) + PNGåŸå§‹æ•°æ®
         */
        async function encodeICO(canvases) {
            const blobs = await Promise.all(canvases.map(c => new Promise(res => c.toBlob(res, 'image/png'))));
            const buffers = await Promise.all(blobs.map(b => b.arrayBuffer()));
            
            const headerSize = 6;
            const directorySize = 16 * canvases.length;
            let currentOffset = headerSize + directorySize;
            
            const icoHeader = new DataView(new ArrayBuffer(headerSize + directorySize));
            
            // Header
            icoHeader.setUint16(0, 0, true);    // Reserved
            icoHeader.setUint16(2, 1, true);    // Type: ICO
            icoHeader.setUint16(4, canvases.length, true); // Number of images
            
            // Directory Entries
            buffers.forEach((buf, i) => {
                const canvas = canvases[i];
                const entryOffset = headerSize + (i * 16);
                icoHeader.setUint8(entryOffset + 0, canvas.width >= 256 ? 0 : canvas.width);
                icoHeader.setUint8(entryOffset + 1, canvas.height >= 256 ? 0 : canvas.height);
                icoHeader.setUint8(entryOffset + 2, 0); // Palette
                icoHeader.setUint8(entryOffset + 3, 0); // Reserved
                icoHeader.setUint16(entryOffset + 4, 1, true); // Color Planes
                icoHeader.setUint16(entryOffset + 6, 32, true); // Bits per pixel
                icoHeader.setUint32(entryOffset + 8, buf.byteLength, true); // Size
                icoHeader.setUint32(entryOffset + 12, currentOffset, true); // Offset
                currentOffset += buf.byteLength;
            });
            
            return new Blob([icoHeader.buffer, ...buffers], { type: 'image/x-icon' });
        }

        const imageInput = document.getElementById('imageInput');
        const dropZone = document.getElementById('drop-zone');
        const editorContainer = document.getElementById('editor-container');
        const cropperImage = document.getElementById('cropperImage');
        const generateBtn = document.getElementById('generateBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const downloadArea = document.getElementById('download-area');

        let cropper = null;
        let generatedBlobs = {};

        const configs = [
            { name: 'favicon-16x16.png', size: 16, previews: ['prev-search', 'prev-tab', 'prev-ico-16'], inIco: true },
            { name: 'favicon-32x32.png', size: 32, previews: ['prev-ico-32'], inIco: true },
            { name: 'favicon-48x48.png', size: 48, previews: ['prev-ico-48'], inIco: true },
            { name: 'favicon-96x96.png', size: 96 },
            { name: 'apple-touch-icon.png', size: 180, previews: ['prev-ios'] },
            { name: 'android-chrome-192x192.png', size: 192, previews: ['prev-android'] },
            { name: 'android-chrome-512x512.png', size: 512 }
        ];

        dropZone.onclick = () => imageInput.click();
        
        const handleFile = (file) => {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                cropperImage.src = e.target.result;
                dropZone.classList.add('hidden');
                editorContainer.classList.remove('hidden');
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropperImage, { aspectRatio: 1, viewMode: 1 });
            };
            reader.readAsDataURL(file);
        };

        imageInput.onchange = (e) => handleFile(e.target.files[0]);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); };
        dropZone.ondrop = (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

        generateBtn.onclick = async () => {
            if (!cropper) return;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="spinner"></div>ç”Ÿæˆä¸­...';

            const sourceCanvas = cropper.getCroppedCanvas({ width: 1024, height: 1024 });
            const icoCanvases = [];

            for (const conf of configs) {
                const canvas = document.createElement('canvas');
                canvas.width = canvas.height = conf.size;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(sourceCanvas, 0, 0, conf.size, conf.size);
                
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                generatedBlobs[conf.name] = blob;
                if (conf.inIco) icoCanvases.push(canvas);

                if (conf.previews) {
                    const url = URL.createObjectURL(blob);
                    conf.previews.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) { el.src = url; el.classList.remove('hidden'); }
                    });
                }
            }

            // ç”Ÿæˆ ICO
            generatedBlobs['favicon.ico'] = await encodeICO(icoCanvases);
            
            document.getElementById('ios-placeholder').classList.add('hidden');
            document.getElementById('android-placeholder').classList.add('hidden');
            downloadArea.classList.remove('hidden');
            generateBtn.disabled = false;
            generateBtn.innerText = 'é‡æ–°ç”Ÿæˆ';
        };

        downloadZipBtn.onclick = async () => {
            const zip = new JSZip();
            const icons = zip.folder("icons");
            for (const name in generatedBlobs) icons.file(name, generatedBlobs[name]);

            // ä½¿ç”¨è½¬ä¹‰çš„æ ‡ç­¾é¿å… HTML è§£æé”™è¯¯
            const html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
<\/head>
<body>å›¾æ ‡å·²é…ç½®<\/body>
<\/html>`;

            zip.file("ä½¿ç”¨è¯´æ˜.html", html);
            zip.file("site.webmanifest", JSON.stringify({
                name: "My App", icons: [
                    { src: "icons/android-chrome-192x192.png", sizes: "192x192", type: "image/png" }
                ]
            }, null, 2));

            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `favicon_pack_${Date.now()}.zip`;
            link.click();
        };
    </script>
</body>
</html>