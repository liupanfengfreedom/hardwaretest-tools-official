<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Pulse - Real Ping</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
body { font-family: Inter, sans-serif; background:#0f172a; color:#f8fafc }
.mono { font-family: "JetBrains Mono", monospace }
.success-line { color:#22c55e }
.error-line { color:#ef4444 }
</style>
</head>

<body class="p-4 md:p-8">
<div class="max-w-6xl mx-auto space-y-6">

<header class="flex justify-between items-center border-b border-slate-800 pb-6">
  <h1 class="text-3xl font-extrabold flex items-center gap-2">
    <i data-lucide="activity" class="text-blue-500"></i>
    Network <span class="text-blue-500">Pulse</span>
  </h1>
  <span id="status" class="text-xs text-slate-400">READY</span>
</header>

<section class="grid md:grid-cols-4 gap-4 bg-slate-900/50 p-6 rounded-xl border border-slate-800">
  <div class="md:col-span-2">
    <label class="text-xs text-slate-400 font-bold">目标地址</label>
    <input id="target"
      placeholder="google.com"
      class="w-full mt-2 bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 mono"
      onkeydown="if(event.key==='Enter') togglePing()">
  </div>

  <div>
    <label class="text-xs text-slate-400 font-bold">次数</label>
    <select id="count"
      class="w-full mt-2 bg-slate-950 border border-slate-700 rounded-lg px-4 py-3">
      <option value="10">10 次</option>
      <option value="50">50 次</option>
      <option value="0">持续</option>
    </select>
  </div>

  <div class="flex items-end">
    <button id="btn" onclick="togglePing()"
      class="w-full bg-blue-600 hover:bg-blue-500 rounded-lg py-3 font-bold flex justify-center gap-2">
      <i data-lucide="play"></i> 开始测试
    </button>
  </div>
</section>

<section class="grid md:grid-cols-4 gap-4">
  <div class="bg-slate-900 p-4 rounded-lg border border-slate-800">
    <p class="text-slate-400 text-sm">平均延迟</p>
    <p class="text-2xl mono"><span id="avg">0</span> ms</p>
  </div>
  <div class="bg-slate-900 p-4 rounded-lg border border-slate-800">
    <p class="text-slate-400 text-sm">丢包率</p>
    <p class="text-2xl mono" id="loss">0%</p>
  </div>
  <div class="bg-slate-900 p-4 rounded-lg border border-slate-800">
    <p class="text-slate-400 text-sm">抖动</p>
    <p class="text-2xl mono"><span id="jitter">0</span> ms</p>
  </div>
  <div class="bg-slate-900 p-4 rounded-lg border border-slate-800">
    <p class="text-slate-400 text-sm">已发送</p>
    <p class="text-2xl mono" id="sent">0</p>
  </div>
</section>

<section class="grid lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 bg-slate-900 p-4 rounded-xl border border-slate-800 h-80">
    <canvas id="chart"></canvas>
  </div>

  <div class="bg-black rounded-xl border border-slate-800 h-80 flex flex-col">
    <div class="text-xs text-slate-400 p-2 border-b border-slate-800">TERMINAL</div>
    <div id="terminal" class="flex-1 p-3 mono text-sm overflow-y-auto"></div>
  </div>
</section>

</div>

<script>
lucide.createIcons();

let running=false, pings=[], sent=0, loss=0, success=0, rid=0;

const chart=new Chart(document.getElementById('chart'),{
  type:'line',
  data:{labels:[],datasets:[{data:[],borderColor:'#3b82f6',tension:.3}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
});

function togglePing(){
  const t=document.getElementById('target').value.trim();
  if(!t) return alert("请输入地址");
  running?stop():start(t);
}

function normalize(t){
  if(!t.startsWith('http')) return 'https://' + t;
  return t;
}

function start(target){
  running=true; rid++;
  pings=[]; sent=loss=success=0;
  chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update();
  document.getElementById('terminal').innerHTML='';
  document.getElementById('btn').innerHTML='<i data-lucide="square"></i> 停止';
  document.getElementById('btn').classList.replace('bg-blue-600','bg-red-600');
  lucide.createIcons();
  loop(normalize(target),parseInt(count.value),rid);
}

function stop(){
  running=false; rid++;
  document.getElementById('btn').innerHTML='<i data-lucide="play"></i> 开始测试';
  document.getElementById('btn').classList.replace('bg-red-600','bg-blue-600');
  lucide.createIcons();
}

async function loop(url,total,id){
  if(!running||id!==rid) return;

  sent++; document.getElementById('sent').innerText=sent;
  const start=performance.now();
  try{
    await fetch(url,{mode:'no-cors',cache:'no-store'});
    const ms=Math.round(performance.now()-start);
    success++; pings.push(ms);
    chart.data.labels.push(sent);
    chart.data.datasets[0].data.push(ms);
    if(chart.data.labels.length>20){chart.data.labels.shift();chart.data.datasets[0].data.shift()}
    chart.update('none');
    log(`回复 ${url} : ${ms} ms`,true);
    updateStats();
  }catch{
    loss++; log('请求失败 / 超时',false); updateStats();
  }

  if(total>0&&sent>=total){stop();return;}
  setTimeout(()=>loop(url,total,id),1000);
}

function updateStats(){
  if(pings.length){
    avg.innerText=Math.round(pings.reduce((a,b)=>a+b)/pings.length);
    if(pings.length>1){
      const m=pings.reduce((a,b)=>a+b)/pings.length;
      jitter.innerText=Math.round(Math.sqrt(pings.map(v=>(v-m)**2).reduce((a,b)=>a+b)/pings.length));
    }
  }
  loss.innerText=Math.round((loss/sent)*100)+'%';
}

function log(t,ok){
  terminal.innerHTML+=`<div class="${ok?'success-line':'error-line'}">${t}</div>`;
  terminal.scrollTop=terminal.scrollHeight;
}
</script>
</body>
</html>
