<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Image Studio - 隐私图片工厂</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.net/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg: #f8fafc;
            --bg-gradient: linear-gradient(135deg, #f6f8ff 0%, #f0f4ff 100%);
            --card: #ffffff;
            --card-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.1), 0 10px 20px -5px rgba(0, 0, 0, 0.04);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --text-light: #94a3b8;
            --accent: #10b981;
            --accent-light: #34d399;
            --warning: #f59e0b;
            --warning-light: #fbbf24;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        html { 
            scrollbar-gutter: stable; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-gradient);
        }
        
        body { 
            color: var(--text-main); 
            margin: 0; 
            padding: 40px 20px;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        header { 
            text-align: center; 
            margin-bottom: 50px; 
            position: relative;
        }
        
        header::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }
        
        header h1 { 
            font-size: 3rem; 
            font-weight: 800; 
            margin: 0; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }
        
        header p { 
            color: var(--text-sub); 
            margin-top: 0; 
            font-size: 1.1rem; 
            opacity: 0.8;
            font-weight: 400;
        }

        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr 380px; 
            gap: 30px; 
            align-items: start; 
        }
        
        @media (max-width: 1024px) { 
            .main-grid { 
                grid-template-columns: 1fr; 
            } 
        }

        .card { 
            background: var(--card); 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--border); 
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: 0 20px 30px -10px rgba(99, 102, 241, 0.15), 0 10px 20px -5px rgba(0, 0, 0, 0.08);
        }

        .workspace {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .upload-area { 
            position: relative; 
            background: linear-gradient(145deg, #ffffff, #f9fafb); 
            border: 2px dashed #d1d5db;
            border-radius: var(--radius-lg); 
            padding: 60px 40px; 
            text-align: center;
            transition: var(--transition); 
            cursor: pointer; 
            margin-bottom: 0;
            backdrop-filter: blur(10px);
        }
        
        .upload-area:hover { 
            border-color: var(--primary); 
            background: linear-gradient(145deg, #fdfdff, #f7f9ff); 
            transform: translateY(-3px); 
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.1);
        }
        
        .upload-area.active {
            border-color: var(--accent);
            background: linear-gradient(145deg, #f0fdf9, #f7f9ff);
        }
        
        .upload-area .icon { 
            font-size: 48px; 
            margin-bottom: 16px; 
            display: block; 
            color: var(--primary);
            opacity: 0.9;
        }
        
        .upload-area b { 
            font-size: 1.3rem; 
            display: block; 
            margin-bottom: 8px; 
            color: var(--text-main);
            font-weight: 700;
        }
        
        .upload-area span { 
            color: var(--text-sub); 
            font-size: 0.9rem; 
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .upload-area .hint {
            margin-top: 16px;
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .progress-bar { 
            height: 6px; 
            background: #f1f5f9; 
            width: 100%; 
            opacity: 0; 
            transition: opacity 0.4s;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-inner { 
            height: 100%; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 0%; 
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 3px;
        }

        #list-card {
            overflow: visible;
        }

        #file-list { 
            width: 100%; 
            border-collapse: collapse; 
            border-spacing: 0;
        }
        
        #file-list th { 
            padding: 18px 20px; 
            text-align: left; 
            font-size: 12px; 
            text-transform: uppercase; 
            color: var(--text-sub); 
            border-bottom: 1px solid var(--border-light); 
            font-weight: 700; 
            letter-spacing: 0.5px;
            background: #fafbfd;
        }
        
        #file-list td { 
            padding: 16px 20px; 
            border-bottom: 1px solid var(--border-light); 
            font-size: 14px; 
            vertical-align: middle; 
        }
        
        #file-list tr:last-child td {
            border-bottom: none;
        }
        
        #file-list tr:hover {
            background-color: #fafbfd;
        }
        
        .thumb-preview { 
            width: 48px; 
            height: 48px; 
            object-fit: cover; 
            border-radius: var(--radius-sm); 
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0); 
            cursor: pointer; 
            transition: var(--transition);
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .thumb-preview:hover { 
            transform: scale(1.15); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .size-info { 
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; 
            color: var(--text-sub); 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 13px;
        }
        
        .size-target { 
            color: var(--primary); 
            font-weight: 700; 
        }

        .status-badge { 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 700; 
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-wait { 
            background: #f1f5f9; 
            color: #64748b; 
        }
        
        .status-ing { 
            background: linear-gradient(90deg, #fef3c7, #fde68a); 
            color: #b45309; 
        }
        
        .status-done { 
            background: linear-gradient(90deg, #d1fae5, #a7f3d0); 
            color: #059669; 
        }
        
        .status-dirty { 
            background: linear-gradient(90deg, #ffedd5, #fed7aa); 
            color: #c2410c; 
        }

        .btn-group { 
            display: flex; 
            gap: 8px; 
            justify-content: flex-end; 
        }
        
        .btn-action { 
            padding: 8px 14px; 
            border-radius: var(--radius-sm); 
            border: 1px solid var(--border); 
            background: #fff; 
            font-size: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: var(--transition); 
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-orig { 
            color: var(--text-sub); 
        }
        
        .btn-orig:hover { 
            background: #f8fafc; 
            border-color: #cbd5e1; 
            transform: translateY(-1px);
        }
        
        .btn-result { 
            color: var(--primary); 
            border-color: #c7d2fe; 
            display: none; 
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }
        
        .btn-result:hover { 
            background: #eef2ff; 
            border-color: var(--primary); 
            transform: translateY(-1px);
        }

        .panel-content { 
            padding: 28px; 
        }
        
        .control-group { 
            margin-bottom: 22px; 
        }
        
        .control-group label { 
            display: block; 
            font-size: 13px; 
            font-weight: 700; 
            margin-bottom: 10px; 
            color: var(--text-main);
            letter-spacing: 0.3px;
        }
        
        select, input { 
            width: 100%; 
            padding: 12px 14px; 
            border: 1px solid var(--border); 
            border-radius: var(--radius-md); 
            font-size: 14px; 
            outline: none; 
            background: #fcfcfd; 
            transition: var(--transition);
            color: var(--text-main);
            font-family: inherit;
        }
        
        select:focus, input:focus { 
            border-color: var(--primary); 
            background: #fff; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .control-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
            -webkit-appearance: none;
        }

        .action-area { 
            position: relative; 
            height: 140px; 
            margin-top: 25px; 
            display: flex;
            flex-direction: column;
        }
        
        .btn-main {
            position: absolute; 
            width: 100%; 
            padding: 18px; 
            border-radius: var(--radius-md); 
            border: none;
            font-weight: 700; 
            font-size: 16px; 
            cursor: pointer; 
            transition: var(--transition);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }
        
        #btn-run { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            top: 40px; 
            z-index: 2;
        }
        
        #btn-run:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
        }
        
        #btn-run:disabled { 
            background: linear-gradient(135deg, #cbd5e1, #94a3b8); 
            color: var(--text-light); 
            cursor: not-allowed; 
            box-shadow: none;
        }
        
        #btn-download-main { 
            background: linear-gradient(135deg, var(--accent), var(--accent-light)); 
            color: white; 
            top: 40px; 
            opacity: 0; 
            pointer-events: none; 
            transform: translateY(15px); 
            z-index: 1; 
        }
        
        #btn-download-main:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }
        
        #btn-download-main.show { 
            opacity: 1; 
            pointer-events: auto; 
            transform: translateY(0); 
            z-index: 3; 
        }

        #hint-text { 
            font-size: 13px; 
            color: var(--warning); 
            text-align: center; 
            height: 20px; 
            opacity: 0; 
            transition: var(--transition); 
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 5px;
        }

        #modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(15, 23, 42, 0.95); 
            z-index: 3000; 
            justify-content: center; 
            align-items: center; 
            cursor: zoom-out; 
            backdrop-filter: blur(10px);
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #modal-content { 
            position: relative; 
            max-width: 90%; 
            max-height: 85%; 
            animation: modalZoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes modalZoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        #modal img { 
            width: 100%; 
            height: 100%; 
            border-radius: var(--radius-md); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
            object-fit: contain; 
        }
        
        #modal-tag { 
            position: absolute; 
            top: -45px; 
            left: 0; 
            color: #fff; 
            font-weight: 700; 
            font-size: 14px; 
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            padding: 8px 16px; 
            border-radius: var(--radius-sm); 
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .footer-info {
            text-align: center;
            margin-top: 40px;
            color: var(--text-light);
            font-size: 13px;
            padding: 20px;
            border-top: 1px solid var(--border-light);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Privacy Image Studio</h1>
        <p>纯本地处理 · 尺寸对比预览 · 全格式支持</p>
    </header>

    <div class="main-grid">
        <div class="workspace">
            <div class="upload-area" id="drop-zone">
                <input type="file" id="file-input" multiple accept="image/*,.heic,.heif,.tiff,.tif" style="display:none">
                <span class="icon"><i class="fas fa-cloud-upload-alt"></i></span>
                <b>添加图片开始处理</b>
                <span>支持 PNG, JPG, WebP, HEIC, TIFF, BMP 等格式 (完全本地处理，不上传服务器)</span>
                <div class="hint"><i class="fas fa-info-circle"></i> 拖放文件到此处或点击选择文件</div>
            </div>
            
            <div class="card" id="list-card" style="display: none;">
                <div class="progress-bar" id="p-bar"><div class="progress-inner" id="p-inner"></div></div>
                <table id="file-list">
                    <thead><tr><th>预览</th><th>文件名</th><th>尺寸变化 (px)</th><th>状态</th><th style="text-align:right">操作</th></tr></thead>
                    <tbody id="queue-body"></tbody>
                </table>
            </div>
        </div>

        <aside>
            <div class="card panel-content">
                <div class="control-group">
                    <label><i class="fas fa-expand-alt"></i> 调整模式</label>
                    <select id="scale-mode" class="param-input">
                        <option value="percent">按比例缩放</option>
                        <option value="width">指定宽度 (等比)</option>
                        <option value="height">指定高度 (等比)</option>
                        <option value="free">自由拉伸</option>
                    </select>
                </div>

                <div id="m-inputs">
                    <div id="m-percent" class="control-group"><label><i class="fas fa-percentage"></i> 比例 (%)</label><input type="number" id="i-percent" class="param-input" value="100" min="1" max="1000"></div>
                    <div id="m-width" class="control-group" style="display:none"><label><i class="fas fa-arrows-alt-h"></i> 宽度 (px)</label><input type="number" id="i-width" class="param-input" value="1920" min="1" max="10000"></div>
                    <div id="m-height" class="control-group" style="display:none"><label><i class="fas fa-arrows-alt-v"></i> 高度 (px)</label><input type="number" id="i-height" class="param-input" value="1080" min="1" max="10000"></div>
                    <div id="m-free" class="control-group" style="display:none">
                        <label><i class="fas fa-expand"></i> 尺寸 (W×H)</label>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="i-free-w" class="param-input" placeholder="宽度" min="1" max="10000">
                            <input type="number" id="i-free-h" class="param-input" placeholder="高度" min="1" max="10000">
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label><i class="fas fa-file-export"></i> 导出目标格式</label>
                    <select id="o-format" class="param-input">
                        <option value="image/png">PNG (无损)</option>
                        <option value="image/jpeg">JPEG (压缩)</option>
                        <option value="image/webp">WebP (现代)</option>
                        <option value="image/bmp">BMP (位图)</option>
                        <option value="image/tiff">TIFF (印刷)</option>
                    </select>
                </div>

                <div class="action-area">
                    <div id="hint-text"><i class="fas fa-exclamation-triangle"></i> 设置已更改，请重新处理</div>
                    <button class="btn-main" id="btn-run" disabled><i class="fas fa-bolt"></i> 开始处理</button>
                    <button class="btn-main" id="btn-download-main"></button>
                </div>
            </div>
        </aside>
    </div>

    <div class="footer-info">
        <p><i class="fas fa-lock"></i> 所有图片处理均在您的浏览器本地完成，不会上传到任何服务器 | <i class="fas fa-code"></i> 基于纯前端技术实现</p>
    </div>
</div>

<div id="modal" onclick="this.style.display='none'">
    <div id="modal-content" onclick="event.stopPropagation()">
        <div id="modal-tag"><i class="fas fa-search"></i> 预览</div>
        <img id="modal-img" src="">
    </div>
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const queueBody = document.getElementById('queue-body');
    const btnRun = document.getElementById('btn-run');
    const btnDownloadMain = document.getElementById('btn-download-main');
    const hintText = document.getElementById('hint-text');
    let fileQueue = [];

    // --- 界面控制 ---
    document.getElementById('scale-mode').onchange = function() {
        ['percent', 'width', 'height', 'free'].forEach(m => {
            const el = document.getElementById(`m-${m}`);
            if (el) el.style.display = (this.value === m ? 'block' : 'none');
        });
        markDirty();
    };

    function updateFileCount() {
        const count = fileQueue.length;
        if (count > 0) {
            document.querySelector('header p').innerHTML = `纯本地处理 · 尺寸对比预览 · 全格式支持 <span class="file-count">${count}</span>`;
        } else {
            document.querySelector('header p').innerText = '纯本地处理 · 尺寸对比预览 · 全格式支持';
        }
    }

    function markDirty() {
        if (fileQueue.length === 0) return;
        hintText.style.opacity = '1';
        btnDownloadMain.classList.remove('show');
        btnRun.style.opacity = '1';
        btnRun.disabled = false;
        btnRun.innerHTML = '<i class="fas fa-sync-alt"></i> 重新处理';
        fileQueue.forEach(item => {
            if (item.status === 'done') {
                item.status = 'dirty';
                const badge = document.getElementById(`st-${item.id}`);
                if (badge) { 
                    badge.innerText = '待更新'; 
                    badge.className = 'status-badge status-dirty';
                    badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> 待更新';
                }
            }
        });
    }

    document.querySelectorAll('.param-input').forEach(el => el.oninput = markDirty);

    // --- 文件导入 ---
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = e => { 
        e.preventDefault(); 
        dropZone.style.borderColor = "var(--primary)"; 
        dropZone.classList.add('active');
    };
    dropZone.ondragleave = () => { 
        dropZone.style.borderColor = "#d1d5db"; 
        dropZone.classList.remove('active');
    };
    dropZone.ondrop = e => { 
        e.preventDefault(); 
        dropZone.style.borderColor = "#d1d5db"; 
        dropZone.classList.remove('active');
        handleFiles(e.dataTransfer.files); 
    };
    fileInput.onchange = e => handleFiles(e.target.files);

    async function handleFiles(files) {
        if (files.length === 0) return;
        document.getElementById('list-card').style.display = 'block';
        btnRun.style.opacity = '1';
        btnRun.disabled = false;
        btnDownloadMain.classList.remove('show');
        btnRun.innerHTML = '<i class="fas fa-bolt"></i> 开始处理';

        for (const file of files) {
            const id = Math.random().toString(36).substr(2, 8);
            const item = { id, file, status: 'wait', resultBlob: null, origUrl: null, resultUrl: null };
            fileQueue.push(item);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img class="thumb-preview" id="t-${id}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48' fill='%23e2e8f0'%3E%3Cpath d='M38 8H10c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h28c2.2 0 4-1.8 4-4V12c0-2.2-1.8-4-4-4zM19 26l-5 7h20l-6-8-4 5-5-4z'/%3E%3C/svg%3E"></td>
                <td><div style="font-weight:700;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${file.name}</div></td>
                <td><div class="size-info" id="sz-${id}"><i class="fas fa-spinner fa-spin"></i> 载入中</div></td>
                <td><span class="status-badge status-wait" id="st-${id}"><i class="fas fa-clock"></i> 等待中</span></td>
                <td>
                    <div class="btn-group">
                        <button class="btn-action btn-orig" id="vo-${id}"><i class="fas fa-eye"></i> 原图</button>
                        <button class="btn-action btn-result" id="vr-${id}"><i class="fas fa-magic"></i> 效果图</button>
                    </div>
                </td>
            `;
            queueBody.appendChild(tr);

            try {
                // 读取原图并计算尺寸
                const canvas = await fileToCanvas(file);
                item.origW = canvas.width;
                item.origH = canvas.height;
                item.origUrl = canvas.toDataURL('image/jpeg', 0.9); // 用于预览
                
                document.getElementById(`sz-${id}`).innerHTML = `<span>${item.origW}×${item.origH}</span>`;
                document.getElementById(`t-${id}`).src = canvas.toDataURL('image/jpeg', 0.2);
                
                // 绑定原图预览
                document.getElementById(`vo-${id}`).onclick = () => showPreview(item.origUrl, '原始图片预览');
                
                // 更新文件计数
                updateFileCount();
            } catch(e) {
                console.error(e);
                document.getElementById(`sz-${id}`).innerHTML = '<span style="color:var(--warning)"><i class="fas fa-exclamation-triangle"></i> 读取失败</span>';
            }
        }
    }

    // --- 核心转换逻辑 ---
    async function fileToCanvas(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'heic' || ext === 'heif') {
            const blob = await heic2any({ blob: file, toType: "image/jpeg" });
            return await imgUrlToCanvas(URL.createObjectURL(blob[0] || blob));
        }
        if (ext === 'tiff' || ext === 'tif') {
            const buffer = await file.arrayBuffer();
            const ifds = UTIF.decode(buffer);
            UTIF.decodeImage(buffer, ifds[0]);
            const rgba = UTIF.toRGBA8(ifds[0]);
            const cvs = document.createElement('canvas');
            cvs.width = ifds[0].width; cvs.height = ifds[0].height;
            cvs.getContext('2d').putImageData(new ImageData(new Uint8ClampedArray(rgba.buffer), cvs.width, cvs.height), 0, 0);
            return cvs;
        }
        return await imgUrlToCanvas(URL.createObjectURL(file));
    }

    function imgUrlToCanvas(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas');
                cvs.width = img.width; cvs.height = img.height;
                cvs.getContext('2d').drawImage(img, 0, 0);
                URL.revokeObjectURL(url);
                resolve(cvs);
            };
            img.onerror = reject;
            img.src = url;
        });
    }

    function showPreview(url, title) {
        document.getElementById('modal-img').src = url;
        document.getElementById('modal-tag').innerHTML = `<i class="fas fa-search"></i> ${title}`;
        document.getElementById('modal').style.display = 'flex';
    }

    // --- 开始处理 ---
    btnRun.onclick = async () => {
        btnRun.disabled = true;
        btnRun.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
        hintText.style.opacity = '0';
        const pBar = document.getElementById('p-bar');
        const pInner = document.getElementById('p-inner');
        pBar.style.opacity = '1';

        const mode = document.getElementById('scale-mode').value;
        const targetFormat = document.getElementById('o-format').value;

        for (let i = 0; i < fileQueue.length; i++) {
            const item = fileQueue[i];
            if (item.status === 'done') continue;

            const badge = document.getElementById(`st-${item.id}`);
            badge.innerHTML = '<i class="fas fa-cog fa-spin"></i> 处理中';
            badge.className = 'status-badge status-ing';

            await new Promise(r => setTimeout(r, 30));

            try {
                const src = await fileToCanvas(item.file);
                let tw, th;
                if (mode === 'percent') {
                    const r = (parseInt(document.getElementById('i-percent').value) || 100) / 100;
                    tw = src.width * r; th = src.height * r;
                } else if (mode === 'width') {
                    tw = parseInt(document.getElementById('i-width').value) || src.width;
                    th = (tw / src.width) * src.height;
                } else if (mode === 'height') {
                    th = parseInt(document.getElementById('i-height').value) || src.height;
                    tw = (th / src.height) * src.width;
                } else {
                    tw = parseInt(document.getElementById('i-free-w').value) || src.width;
                    th = parseInt(document.getElementById('i-free-h').value) || src.height;
                }
                
                // 四舍五入尺寸
                tw = Math.round(tw); th = Math.round(th);

                const cvs = document.createElement('canvas');
                cvs.width = tw; cvs.height = th;
                const ctx = cvs.getContext('2d');
                ctx.imageSmoothingEnabled = true; 
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(src, 0, 0, tw, th);

                if (targetFormat === 'image/tiff') {
                    const rgba = ctx.getImageData(0, 0, tw, th).data;
                    item.resultBlob = new Blob([UTIF.encodeImage(rgba, tw, th)], { type: 'image/tiff' });
                } else {
                    item.resultBlob = await new Promise(r => cvs.toBlob(r, targetFormat, 0.92));
                }

                // 更新状态和 URL
                if (item.resultUrl) URL.revokeObjectURL(item.resultUrl);
                item.resultUrl = URL.createObjectURL(item.resultBlob);
                item.status = 'done';

                // 更新 UI 上的尺寸对比
                document.getElementById(`sz-${item.id}`).innerHTML = `
                    <span>${item.origW}×${item.origH}</span>
                    <span style="color:#cbd5e1"><i class="fas fa-arrow-right"></i></span>
                    <span class="size-target">${tw}×${th}</span>
                `;

                badge.innerHTML = '<i class="fas fa-check-circle"></i> 已就绪';
                badge.className = 'status-badge status-done';
                
                const rBtn = document.getElementById(`vr-${item.id}`);
                rBtn.style.display = 'flex';
                rBtn.onclick = () => showPreview(item.resultUrl, '处理结果预览');
                
                pInner.style.width = `${((i+1)/fileQueue.length)*100}%`;
            } catch(e) {
                console.error(`处理文件 ${item.file.name} 时出错:`, e);
                badge.innerHTML = '<i class="fas fa-times-circle"></i> 处理失败';
                badge.className = 'status-badge status-dirty';
            }
        }

        btnRun.style.opacity = '0';
        setTimeout(() => {
            if (fileQueue.length === 1) {
                btnDownloadMain.innerHTML = '<i class="fas fa-download"></i> 保存到电脑';
            } else {
                btnDownloadMain.innerHTML = `<i class="fas fa-file-archive"></i> 打包下载全部 (${fileQueue.length}张)`;
            }
            btnDownloadMain.classList.add('show');
            pBar.style.opacity = '0';
            btnRun.innerHTML = '<i class="fas fa-sync-alt"></i> 重新处理';
        }, 400);
    };

    btnDownloadMain.onclick = async () => {
        const ext = document.getElementById('o-format').value.split('/')[1].replace('jpeg', 'jpg');
        if (fileQueue.length === 1) {
            const a = document.createElement('a');
            a.href = fileQueue[0].resultUrl;
            a.download = `${fileQueue[0].file.name.split('.')[0]}_processed.${ext}`;
            a.click();
        } else {
            btnDownloadMain.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 打包中...';
            try {
                const zip = new JSZip();
                fileQueue.forEach(item => {
                    if (item.resultBlob) {
                        zip.file(`${item.file.name.split('.')[0]}.${ext}`, item.resultBlob);
                    }
                });
                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = `Privacy_Studio_Export_${new Date().toISOString().slice(0,10)}.zip`;
                a.click();
            } finally {
                setTimeout(() => {
                    if (fileQueue.length === 1) {
                        btnDownloadMain.innerHTML = '<i class="fas fa-download"></i> 保存到电脑';
                    } else {
                        btnDownloadMain.innerHTML = `<i class="fas fa-file-archive"></i> 打包下载全部 (${fileQueue.length}张)`;
                    }
                }, 500);
            }
        }
    };
</script>
</body>
</html>