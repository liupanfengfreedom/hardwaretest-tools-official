<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¸“ä¸šé¼ æ ‡æ»šè½®æµ‹è¯•å·¥å…· | Mouse Wheel Tester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="ä¸“ä¸šç½‘é¡µç‰ˆé¼ æ ‡æ»šè½®æµ‹è¯•å·¥å…·ï¼Œæ£€æµ‹æ»šè½®ä¸¢æ­¥ã€åå‘æ»šåŠ¨ã€æŠ–åŠ¨ã€æ»šåŠ¨é¢‘ç‡ä¸ç¨³å®šæ€§ï¼Œæ”¯æŒä¸­è‹±æ–‡ã€‚" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2933;
      --accent: #38bdf8;
      --good: #22c55e;
      --bad: #ef4444;
      --text: #e5e7eb;
      --muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #020617, #0f172a);
      color: var(--text);
      overflow-x: hidden;
    }
    header {
      padding: 24px;
      text-align: center;
    }
    header h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }
    header p {
      margin: 0;
      color: var(--muted);
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 300px 1fr 400px;
      gap: 16px;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
    }
    #testArea {
      height: 300px;
      border: 2px dashed var(--accent);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--muted);
      user-select: none;
    }
    #testArea.active {
      background: rgba(56,189,248,0.08);
      color: var(--text);
    }
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .stat {
      background: var(--panel);
      border-radius: 12px;
      padding: 12px;
    }
    .stat span {
      display: block;
      font-size: 12px;
      color: var(--muted);
    }
    .stat strong {
      font-size: 20px;
    }
    .log-container {
      height: 400px;
      display: flex;
      flex-direction: column;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .log {
      flex: 1;
      overflow: auto;
      font-size: 12px;
      background: #020617;
      padding: 8px;
      border-radius: 8px;
      display: flex;
      flex-direction: column-reverse;
    }
    .log-content {
      display: flex;
      flex-direction: column;
    }
    .log div.up { color: var(--good); }
    .log div.down { color: var(--accent); }
    .log div.err { color: var(--bad); }
    .log div.info { color: var(--muted); }
    .controls button {
      margin-right: 8px;
      margin-top: 8px;
      background: var(--accent);
      color: #020617;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
    }
    /* è¡Œæ•°æµ‹è¯•é¢æ¿æ¿€æ´»çŠ¶æ€æ ·å¼ */
    #lineTestCard {
      position: relative;
      overflow: hidden;
    }
    
    #lineTestCard::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background-color: var(--muted);
      transition: background-color 0.3s ease;
    }
    
    #lineTestCard.active::before {
      background-color: var(--good);
      box-shadow: 0 0 10px var(--good);
    }
    
    #lineTestCard.active {
      border: 2px solid var(--good);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    
    /* æ¿€æ´»çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .active-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    
    #lineTestCard.active .active-indicator {
      opacity: 1;
      transform: translateY(0);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--muted);
      transition: all 0.3s ease;
    }
    
    #lineTestCard.active .status-dot {
      background-color: var(--good);
      box-shadow: 0 0 8px var(--good);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    /* æ¿€æ´»çŠ¶æ€æ ‡é¢˜ */
    .card-title-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .card-title-container h2 {
      margin: 0;
      font-size: 18px;
    }
    
    /* æ”¹è¿›çš„æç¤ºæ ·å¼ */
    .test-hint {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      padding: 12px;
      border-radius: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      background: rgba(148, 163, 184, 0.15);
      border: 2px solid rgba(148, 163, 184, 0.3);
      animation: hintPulse 2s infinite;
    }
    
    @keyframes hintPulse {
      0% { box-shadow: 0 0 0 0 rgba(148, 163, 184, 0.4); }
      50% { box-shadow: 0 0 0 5px rgba(148, 163, 184, 0); }
      100% { box-shadow: 0 0 0 0 rgba(148, 163, 184, 0); }
    }
    
    #lineTestCard.active .test-hint {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.5);
      color: var(--good);
      animation: activeHintPulse 1.5s infinite;
    }
    
    @keyframes activeHintPulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.5); }
      50% { box-shadow: 0 0 0 5px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    .test-hint-icon {
      font-size: 18px;
    }
    
    /* æ»šåŠ¨æ¡†æ¿€æ´»çŠ¶æ€ */
    #scrollBox {
      height: 333px;
      width: 100%;
      overflow-y: auto;
      background: #020617;
      border-radius: 8px;
      padding: 6px;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      transition: border-color 0.3s ease;
      line-height: 20px;
    }
    
    #lineTestCard.active #scrollBox {
      border-color: var(--good);
      box-shadow: inset 0 0 10px rgba(34, 197, 94, 0.1);
    }
    
    /* æ–‡æœ¬æ¡†ä¸­çš„è¡Œæ ·å¼ */
    .scroll-line {
      height: 20px;
      line-height: 20px;
      white-space: nowrap;
      border-bottom: 1px dashed #1f2937;
      transition: background-color 0.2s ease;
      position: relative;
    }
    
    .scroll-line.highlight {
      background-color: rgba(56, 189, 248, 0.2);
    }
    
    /* è¡Œé«˜æ ‡å°º */
    .ruler {
      position: absolute;
      left: -30px;
      top: 0;
      width: 25px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--muted);
      background: rgba(0, 0, 0, 0.3);
      border-right: 1px solid var(--muted);
    }
    
    footer {
      text-align: center;
      padding: 16px;
      color: var(--muted);
      font-size: 12px;
    }
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr 1fr;
      }
    }
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>ä¸“ä¸šé¼ æ ‡æ»šè½®æµ‹è¯•å·¥å…·</h1>
  <p>Mouse Wheel Diagnostic & Stability Tester (Web)</p>
</header>

<div class="container">
  <!-- å·¦ä¾§ï¼šæ»šè½®è¡Œæ•°æµ‹è¯• -->
  <div class="card" id="lineTestCard">
    <div class="active-indicator">
      <div class="status-dot"></div>
      <span>æµ‹è¯•æ¿€æ´»</span>
    </div>
    
    <div class="card-title-container">
      <h2>æ»šè½®åˆ»åº¦è¡Œæ•°æµ‹è¯•</h2>
    </div>
    
    <div class="test-hint" id="lineTestHint">
      <span class="test-hint-icon">ğŸ–±ï¸</span>
      <span id="hintText">é¼ æ ‡ç§»å…¥æ­¤åŒºåŸŸå¼€å§‹æµ‹è¯•</span>
    </div>
    
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">
      æ¯æ¬¡åªæ»šåŠ¨ä¸€æ ¼æ»šè½®ï¼Œè§‚å¯Ÿè·³è¿‡çš„è¡Œæ•°ã€‚
      <br><small>æµ‹è¯•åŸºå‡†ï¼šæ¯è¡Œå›ºå®šé«˜åº¦20pxï¼ˆ13pxå­—ä½“ Ã— 1.54è¡Œé«˜ï¼‰</small>
    </p>
    
    <div id="scrollBox"></div>
    
    <div style="margin-top:12px; padding:12px; background:var(--panel); border-radius:8px;">
      <h3 style="margin-top:0;font-size:14px;">è¡Œæ•°åˆ†æ</h3>
      <div id="lineAnalysis" style="font-size:12px;color:var(--muted)">
        ç­‰å¾…æµ‹è¯•å¼€å§‹...
      </div>
    </div>
  </div>

  <!-- ä¸­é—´ï¼šæ»šè½®æµ‹è¯•åŒº -->
  <div class="card">
    <h2>æ»šè½®æµ‹è¯•åŒº</h2>
    <div style="font-size:13px;color:var(--muted);margin-bottom:8px">
      æµ‹è¯•æ»šè½®ç²¾åº¦ã€åå‘æ»šåŠ¨ã€æŠ–åŠ¨å’Œæ»šåŠ¨é¢‘ç‡
    </div>
    <div id="testArea">å°†é¼ æ ‡ç§»å…¥æ­¤åŒºåŸŸå¹¶æ»šåŠ¨æ»šè½®<br/>Scroll mouse wheel here</div>

    <div class="stats">
      <div class="stat"><span>å‘ä¸Šæ»šåŠ¨æ¬¡æ•°</span><strong id="upCount">0</strong></div>
      <div class="stat"><span>å‘ä¸‹æ»šåŠ¨æ¬¡æ•°</span><strong id="downCount">0</strong></div>
      <div class="stat"><span>åå‘é”™è¯¯</span><strong id="reverseCount">0</strong></div>
      <div class="stat"><span>æœ€å¤§æ»šåŠ¨é¢‘ç‡ (Hz)</span><strong id="maxHz">0</strong></div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div style="margin-top:16px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div style="padding:12px; background:var(--panel); border-radius:8px;">
        <h3 style="margin-top:0;font-size:14px;">æµ‹é‡åŸºå‡†</h3>
        <div id="testStats" style="font-size:12px;color:var(--muted);">
          <div>å­—ä½“å¤§å°: 13px</div>
          <div>è¡Œé«˜: 20px (1.54Ã—)</div>
          <div>æ»šåŠ¨å•ä½: deltaY (åƒç´ )</div>
          <div>è®¡ç®—: deltaY Ã· 20px</div>
        </div>
      </div>
      <div style="padding:12px; background:var(--panel); border-radius:8px;">
        <h3 style="margin-top:0;font-size:14px;">ç»“æœè§£è¯»</h3>
        <ul style="font-size:12px;color:var(--muted);margin:0;padding-left:16px;">
          <li>1.00 = å®Œç¾åŒ¹é…20px/è¡Œ</li>
          <li>1.68 = ç³»ç»Ÿå‘é€33.6px/æ»šåŠ¨</li>
          <li>0.80 = ç³»ç»Ÿå‘é€16px/æ»šåŠ¨</li>
          <li>é‡ç‚¹è§‚å¯Ÿç›¸å¯¹ç¨³å®šæ€§</li>
        </ul>
      </div>
    </div>

    <div style="margin-top:16px; padding:12px; background:var(--panel); border-radius:8px;">
      <h3 style="margin-top:0;font-size:14px;">ä¸ºä»€ä¹ˆæµ‹é‡å€¼ä¸æ˜¯1.00ï¼Ÿ</h3>
      <p style="font-size:12px;color:var(--muted);margin:0">
        1. <b>DPIç¼©æ”¾å½±å“</b>: ç³»ç»Ÿ125%ç¼©æ”¾å¯¼è‡´1.25å€<br>
        2. <b>æµè§ˆå™¨å·®å¼‚</b>: ä¸åŒæµè§ˆå™¨å¤„ç†æ–¹å¼ä¸åŒ<br>
        3. <b>ç³»ç»Ÿå¹³æ»‘æ»šåŠ¨</b>: å¯èƒ½äº§ç”Ÿéæ•´æ•°å€¼<br>
        4. <b>æµ‹é‡å·¥å…·ç‰¹æ€§</b>: å›ºå®š20pxè¡Œé«˜ä½œä¸ºåŸºå‡†
      </p>
    </div>
  </div>

  <!-- å³ä¾§ï¼šäº‹ä»¶æ—¥å¿— -->
  <div class="card log-container">
    <div class="log-header">
      <h2 style="margin:0">äº‹ä»¶æ—¥å¿—</h2>
      <div>
        <button onclick="clearLog()" style="background:var(--muted);font-size:11px;padding:4px 8px;">æ¸…ç©ºæ—¥å¿—</button>
        <button onclick="exportData()" style="background:var(--accent);font-size:11px;padding:4px 8px;">å¯¼å‡ºæ•°æ®</button>
      </div>
    </div>
    <div class="log" id="log">
      <div class="log-content" id="logContent"></div>
    </div>
    
    <div style="margin-top:16px">
      <h3 style="margin-top:0;font-size:14px;">æ§åˆ¶é¢æ¿</h3>
      <div class="controls">
        <button onclick="resetTest()">é‡ç½®æ‰€æœ‰æµ‹è¯•</button>
      </div>
    </div>
    
    <div style="margin-top:16px; padding:12px; background:var(--panel); border-radius:8px;">
      <h3 style="margin-top:0;font-size:14px;">ä¸“ä¸šå»ºè®®</h3>
      <ul style="font-size:12px;color:var(--muted);margin:0;padding-left:16px;">
        <li><b>è¯Šæ–­ç›®çš„</b>: å…³æ³¨æ»šè½®ç¨³å®šæ€§è€Œéç»å¯¹å€¼</li>
        <li><b>å¯¹æ¯”æµ‹è¯•</b>: åŒä¸€ç¯å¢ƒä¸‹æ¯”è¾ƒä¸åŒé¼ æ ‡</li>
        <li><b>ç³»ç»Ÿæ ¡å‡†</b>: æµ‹é‡å€¼1.68è¡¨æ˜ç³»ç»Ÿå‘é€33.6px</li>
        <li><b>å®ç”¨æ„ä¹‰</b>: äº†è§£å®é™…æ»šåŠ¨è¡Œä¸ºæ¯”ç†è®ºå€¼æ›´é‡è¦</li>
      </ul>
    </div>
  </div>
</div>

<footer>
  Â© Mouse Wheel Tester Â· Web Diagnostic Tool
</footer>

<script>
  // åˆå§‹åŒ–å˜é‡
  const scrollBox = document.getElementById('scrollBox');
  const lineTestCard = document.getElementById('lineTestCard');
  const hintText = document.getElementById('hintText');
  const testArea = document.getElementById('testArea');
  const upEl = document.getElementById('upCount');
  const downEl = document.getElementById('downCount');
  const reverseEl = document.getElementById('reverseCount');
  const maxHzEl = document.getElementById('maxHz');
  const logContent = document.getElementById('logContent');
  const lineAnalysis = document.getElementById('lineAnalysis');
  
  // ç»Ÿè®¡å…ƒç´ 
  const totalScrollsEl = document.getElementById('totalScrolls');
  const reverseRateEl = document.getElementById('reverseRate');
  const upDownRatioEl = document.getElementById('upDownRatio');
  const avgIntervalEl = document.getElementById('avgInterval');

  let upCount = 0;
  let downCount = 0;
  let reverseCount = 0;
  let lastDir = null;
  let lastTime = null;
  let maxHz = 0;
  let scrollTimes = []; // è®°å½•æ»šåŠ¨æ—¶é—´æˆ³ï¼Œç”¨äºè®¡ç®—å¹³å‡é—´éš”
  
  // è¡Œæ•°æµ‹è¯•ç›¸å…³å˜é‡
  let lineScrollSamples = [];
  let lastBoxScrollTop = 0;
  let isLineTestActive = false;
  let lineTestStartTime = null;
  let lineElements = [];
  
  // æµ‹é‡åŸºå‡† - è¿™æ˜¯å›ºå®šçš„æ ‡å‡†
  const FONT_SIZE = 13; // å­—ä½“å¤§å°
  const LINE_HEIGHT = 33.3; // è¡Œé«˜ - å›ºå®šåŸºå‡†å€¼
  const LINE_HEIGHT_RATIO = (LINE_HEIGHT / FONT_SIZE).toFixed(2); // è¡Œé«˜æ¯”ä¾‹

  // åˆå§‹åŒ–æ»šåŠ¨æ¡†å†…å®¹
  function initScrollBox() {
    scrollBox.innerHTML = '';
    lineElements = [];
    
    for (let i = 1; i <= 1000; i++) {
      const line = document.createElement('div');
      line.textContent = `ç¬¬ ${i} è¡Œ / Line ${i}`;
      line.className = 'scroll-line';
      line.style.height = `${LINE_HEIGHT}px`;
      line.style.lineHeight = `${LINE_HEIGHT}px`;
      
      // æ·»åŠ è¡Œé«˜æ ‡å°º
      if (i % 5 === 0) {
        const ruler = document.createElement('div');
        ruler.className = 'ruler';
        ruler.textContent = `${LINE_HEIGHT}px`;
        line.appendChild(ruler);
      }
      
      lineElements.push(line);
      scrollBox.appendChild(line);
    }
  }

  // é«˜äº®å½“å‰è¡Œ
  function highlightCurrentLine() {
    // ç§»é™¤ä¹‹å‰çš„é«˜äº®
    lineElements.forEach(line => line.classList.remove('highlight'));
    
    // è®¡ç®—å½“å‰è¡Œç´¢å¼•
    const scrollTop = scrollBox.scrollTop;
    const currentLineIndex = Math.floor(scrollTop / LINE_HEIGHT);
    
    // é«˜äº®å½“å‰è¡Œ
    if (currentLineIndex >= 0 && currentLineIndex < lineElements.length) {
      lineElements[currentLineIndex].classList.add('highlight');
    }
  }

  // å¼€å§‹è¡Œæ•°æµ‹è¯•
  function startLineTest() {
    if (isLineTestActive) return;
    
    isLineTestActive = true;
    lineScrollSamples = [];
    lineTestStartTime = Date.now();
    scrollBox.scrollTop = 0;
    lastBoxScrollTop = 0;
    
    // æ›´æ–°æ¿€æ´»çŠ¶æ€
    lineTestCard.classList.add('active');
    hintText.textContent = 'âœ… æµ‹è¯•è¿›è¡Œä¸­...è¯·ç¼“æ…¢æ»šåŠ¨æ»šè½®';
    
    // æ›´æ–°åˆ†æåŒºåŸŸ
    lineAnalysis.innerHTML = 'æµ‹è¯•è¿›è¡Œä¸­...<br>è¯·ç¼“æ…¢æ»šåŠ¨æ»šè½®ï¼Œæ¯æ¬¡åªæ»šåŠ¨ä¸€æ ¼<br><small>åŸºå‡†ï¼š20px/è¡Œ</small>';
    
    // é«˜äº®å½“å‰è¡Œ
    highlightCurrentLine();
    
    addLog('è¡Œæ•°æµ‹è¯•å·²å¼€å§‹ï¼Œè¯·ç¼“æ…¢æ»šåŠ¨æ»šè½®', 'info');
    addLog(`æµ‹é‡åŸºå‡†ï¼šå­—ä½“${FONT_SIZE}pxï¼Œè¡Œé«˜${LINE_HEIGHT}pxï¼ˆ${LINE_HEIGHT_RATIO}å€ï¼‰`, 'info');
  }

  // åœæ­¢è¡Œæ•°æµ‹è¯•
  function stopLineTest() {
    if (!isLineTestActive) return;
    
    isLineTestActive = false;
    
    // æ›´æ–°æ¿€æ´»çŠ¶æ€
    lineTestCard.classList.remove('active');
    hintText.textContent = 'ğŸ–±ï¸ é¼ æ ‡ç§»å…¥æ­¤åŒºåŸŸå¼€å§‹æµ‹è¯•';
    
    // åˆ†ææ•°æ®
    analyzeLineData();
    
    const duration = ((Date.now() - lineTestStartTime) / 1000).toFixed(1);
    addLog(`è¡Œæ•°æµ‹è¯•ç»“æŸï¼ŒæŒç»­${duration}ç§’ï¼Œæ”¶é›†${lineScrollSamples.length}ä¸ªæ ·æœ¬`, 'info');
  }

  // å¤„ç†é¢æ¿æ»šè½®äº‹ä»¶
  function handleLineTestWheel(e) {
    // å¦‚æœè¡Œæ•°æµ‹è¯•æœªæ¿€æ´»ï¼Œåˆ™ä¸å¤„ç†
    if (!isLineTestActive) return;
    
    // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢ç½‘é¡µæ»šåŠ¨
    e.preventDefault();
    e.stopPropagation();
    
    // è·å–æµè§ˆå™¨å‘é€çš„åŸå§‹deltaYå€¼
    const rawDeltaY = e.deltaY;
    const deltaMode = e.deltaMode; // 0: åƒç´ , 1: è¡Œ, 2: é¡µ
    
    // æ‰§è¡Œæ»šåŠ¨ - ä½¿ç”¨åŸå§‹deltaYå€¼
    // æµè§ˆå™¨ä¼šè‡ªåŠ¨åº”ç”¨ç³»ç»Ÿè®¾ç½®å’ŒDPIç¼©æ”¾
    scrollBox.scrollBy({ top: rawDeltaY, behavior: 'auto' });
    
    // è®¡ç®—å®é™…æ»šåŠ¨çš„åƒç´ è·ç¦»
    const currentScrollTop = scrollBox.scrollTop;
    const deltaPx = Math.abs(currentScrollTop - lastBoxScrollTop);
    
    // è½¬æ¢ä¸ºè¡Œæ•°ï¼ˆä½¿ç”¨å›ºå®šçš„è¡Œé«˜åŸºå‡†ï¼‰
    const deltaLines = deltaPx / LINE_HEIGHT;
    
    // è·å–æ¨¡å¼æè¿°
    let modeDesc = '';
    switch(deltaMode) {
      case 0: modeDesc = 'åƒç´ '; break;
      case 1: modeDesc = 'è¡Œ'; break;
      case 2: modeDesc = 'é¡µ'; break;
      default: modeDesc = 'æœªçŸ¥';
    }
    
    // è®°å½•è¯¦ç»†äº‹ä»¶ä¿¡æ¯
    if (deltaLines > 0.05 && deltaLines < 10) {
      lineScrollSamples.push(deltaLines);
      
      // è®°å½•è¯¦ç»†æ—¥å¿—
      const logMsg = `ğŸ“ æ¨¡å¼:${modeDesc} deltaY:${rawDeltaY.toFixed(1)}px æ»šåŠ¨:${deltaPx.toFixed(1)}px è¡Œæ•°:${deltaLines.toFixed(2)}`;
      addLog(logMsg, 'info');
      
      // ç«‹å³åˆ†ææ•°æ®
      analyzeLineData();
    }
    
    lastBoxScrollTop = currentScrollTop;
    
    // é«˜äº®å½“å‰è¡Œ
    highlightCurrentLine();
    
    // è¿”å›falseè¿›ä¸€æ­¥ç¡®ä¿é˜»æ­¢é»˜è®¤è¡Œä¸º
    return false;
  }

  // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
  function updateStats() {
    const totalScrolls = upCount + downCount;
    totalScrollsEl.textContent = totalScrolls;
    
    // è®¡ç®—åå‘é”™è¯¯ç‡
    const reverseRate = totalScrolls > 0 ? ((reverseCount / totalScrolls) * 100).toFixed(1) : 0;
    reverseRateEl.textContent = `${reverseRate}%`;
    
    // è®¡ç®—ä¸Š/ä¸‹æ¯”ä¾‹
    upDownRatioEl.textContent = `${upCount}:${downCount}`;
    
    // è®¡ç®—å¹³å‡é—´éš”
    if (scrollTimes.length > 1) {
      const intervals = [];
      for (let i = 1; i < scrollTimes.length; i++) {
        intervals.push(scrollTimes[i] - scrollTimes[i-1]);
      }
      const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
      avgIntervalEl.textContent = `${avgInterval.toFixed(0)}ms`;
    } else {
      avgIntervalEl.textContent = "0ms";
    }
  }

  // æ·»åŠ æ—¥å¿—
  function addLog(msg, type = 'info') {
    const now = new Date();
    const timeStr = now.toTimeString().split(' ')[0];
    const logEntry = document.createElement('div');
    logEntry.textContent = `[${timeStr}] ${msg}`;
    logEntry.className = type;
    
    // æ·»åŠ åˆ°æ—¥å¿—å†…å®¹
    logContent.appendChild(logEntry);
    
    // é™åˆ¶æ—¥å¿—æ•°é‡
    const logs = logContent.children;
    if (logs.length > 100) {
      logContent.removeChild(logs[0]);
    }
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
  }

  // åˆ†æè¡Œæ•°æ•°æ®
  function analyzeLineData() {
    if (lineScrollSamples.length === 0) {
      lineAnalysis.innerHTML = 'æœªæ”¶é›†åˆ°æ•°æ®<br>è¯·ç¡®ä¿æ¯æ¬¡åªæ»šåŠ¨ä¸€æ ¼';
      return;
    }
    
    const sum = lineScrollSamples.reduce((a, b) => a + b, 0);
    const avg = sum / lineScrollSamples.length;
    const min = Math.min(...lineScrollSamples);
    const max = Math.max(...lineScrollSamples);
    
    // è®¡ç®—æ ‡å‡†å·®
    const squareDiffs = lineScrollSamples.map(value => Math.pow(value - avg, 2));
    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / lineScrollSamples.length;
    const stdDev = Math.sqrt(avgSquareDiff).toFixed(2);
    
    // è®¡ç®—å˜å¼‚ç³»æ•° (CV) - ç›¸å¯¹ç¨³å®šæ€§æŒ‡æ ‡
    const cv = ((stdDev / avg) * 100).toFixed(1);
    
    // åˆ†æç»“æœ
    let stabilityAnalysis = '';
    let stabilityColor = '';
    
    if (cv < 10) {
      stabilityAnalysis = 'âœ“ æ»šè½®ç¨³å®šæ€§ä¼˜ç§€';
      stabilityColor = 'var(--good)';
    } else if (cv < 20) {
      stabilityAnalysis = 'â†” æ»šè½®ç¨³å®šæ€§è‰¯å¥½';
      stabilityColor = 'var(--accent)';
    } else {
      stabilityAnalysis = 'âš  æ»šè½®å¯èƒ½å­˜åœ¨æŠ–åŠ¨';
      stabilityColor = 'var(--bad)';
    }
    
    // è®¡ç®—ç³»ç»Ÿå®é™…å‘é€çš„åƒç´ å€¼
    const systemPixelsPerScroll = avg * LINE_HEIGHT;
    
    // æä¾›è§£é‡Š
    let explanation = '';
    if (Math.abs(avg - 1.0) < 0.1) {
      explanation = 'ï¼ˆç³»ç»Ÿå‘é€çº¦20px/æ»šåŠ¨ï¼‰';
    } else if (avg > 1.0) {
      const multiplier = avg.toFixed(2);
      explanation = `ï¼ˆç³»ç»Ÿå‘é€çº¦${systemPixelsPerScroll.toFixed(1)}px/æ»šåŠ¨ = ${multiplier}Ã—åŸºå‡†ï¼‰`;
    } else {
      const multiplier = avg.toFixed(2);
      explanation = `ï¼ˆç³»ç»Ÿå‘é€çº¦${systemPixelsPerScroll.toFixed(1)}px/æ»šåŠ¨ = ${multiplier}Ã—åŸºå‡†ï¼‰`;
    }
    
    // è®¡ç®—DPIç¼©æ”¾å› å­ä¼°è®¡
    const estimatedScaling = (systemPixelsPerScroll / 20).toFixed(2);
    let scalingNote = '';
    if (estimatedScaling > 1.1) {
      scalingNote = `<div style="font-size:10px;color:var(--accent);margin-top:2px">ä¼°è®¡ç³»ç»ŸDPIç¼©æ”¾: ${estimatedScaling}å€</div>`;
    }
    
    lineAnalysis.innerHTML = `
      <div>æµ‹è¯•æ¬¡æ•°: ${lineScrollSamples.length}</div>
      <div>å¹³å‡è¡Œæ•°: ${avg.toFixed(2)} è¡Œ/åˆ»åº¦ ${explanation}</div>
      <div>æ³¢åŠ¨èŒƒå›´: ${min.toFixed(2)} - ${max.toFixed(2)} è¡Œ</div>
      <div>æ ‡å‡†å·®: ${stdDev} (å˜å¼‚ç³»æ•°: ${cv}%)</div>
      <div style="margin-top:4px; color:${stabilityColor}">${stabilityAnalysis}</div>
      ${scalingNote}
    `;
  }

  // è¡Œæ•°æµ‹è¯•å¡ç‰‡é¼ æ ‡äº‹ä»¶
  lineTestCard.addEventListener('mouseenter', (e) => {
    // ç¡®ä¿é¼ æ ‡ç¡®å®åœ¨å¡ç‰‡åŒºåŸŸå†…
    const rect = lineTestCard.getBoundingClientRect();
    const isInCard = e.clientX >= rect.left && e.clientX <= rect.right && 
                     e.clientY >= rect.top && e.clientY <= rect.bottom;
    
    if (isInCard) {
      startLineTest();
    }
  });

  lineTestCard.addEventListener('mouseleave', (e) => {
    // ç¡®ä¿é¼ æ ‡ç¡®å®ç¦»å¼€äº†å¡ç‰‡åŒºåŸŸ
    const rect = lineTestCard.getBoundingClientRect();
    const isInCard = e.clientX >= rect.left && e.clientX <= rect.right && 
                     e.clientY >= rect.top && e.clientY <= rect.bottom;
    
    if (!isInCard) {
      stopLineTest();
    }
  });

  // ä¸ºæ•´ä¸ªé¢æ¿æ·»åŠ æ»šè½®äº‹ä»¶ç›‘å¬å™¨
  lineTestCard.addEventListener('wheel', handleLineTestWheel, { passive: false });

  // ä¸ºæ»šåŠ¨æ¡†æ·»åŠ æ»šè½®äº‹ä»¶ç›‘å¬å™¨
  scrollBox.addEventListener('wheel', handleLineTestWheel, { passive: false });

  // ä¸ºæ»šåŠ¨æ¡†æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬
  scrollBox.addEventListener('scroll', function() {
    if (isLineTestActive) {
      highlightCurrentLine();
    }
  });

  // æµ‹è¯•åŒºæ»šè½®äº‹ä»¶
  testArea.addEventListener('mouseenter', () => {
    testArea.classList.add('active');
    testArea.innerHTML = 'æ­£åœ¨æ»šåŠ¨æµ‹è¯•...<br>è¯·æ»šåŠ¨æ»šè½®æŸ¥çœ‹æµ‹è¯•ç»“æœ';
  });

  testArea.addEventListener('mouseleave', () => {
    testArea.classList.remove('active');
    testArea.innerHTML = 'å°†é¼ æ ‡ç§»å…¥æ­¤åŒºåŸŸå¹¶æ»šåŠ¨æ»šè½®<br/>Scroll mouse wheel here';
  });

  testArea.addEventListener('wheel', function(e) {
    e.preventDefault();
    
    const dir = Math.sign(e.deltaY);
    const now = performance.now();
    
    // è®°å½•æ»šåŠ¨æ—¶é—´
    scrollTimes.push(now);
    if (scrollTimes.length > 50) {
      scrollTimes.shift();
    }
    
    // æ›´æ–°è®¡æ•°
    if (dir < 0) upCount++;
    if (dir > 0) downCount++;
    
    // æ£€æµ‹åå‘æ»šåŠ¨
    if (lastDir !== null && dir !== lastDir) {
      reverseCount++;
      addLog('æ£€æµ‹åˆ°åå‘æ»šåŠ¨ï¼', 'err');
    }
    
    // è®¡ç®—é¢‘ç‡
    if (lastTime !== null) {
      const dt = (now - lastTime) / 1000;
      const hz = 1 / dt;
      if (hz > maxHz) {
        maxHz = hz;
        maxHzEl.textContent = maxHz.toFixed(1);
      }
    }
    
    // æ›´æ–°æ˜¾ç¤º
    upEl.textContent = upCount;
    downEl.textContent = downCount;
    reverseEl.textContent = reverseCount;
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    updateStats();
    
    // æ·»åŠ æ—¥å¿—
    addLog(dir < 0 ? `â†‘ ä¸Šæ»šåŠ¨ - æ€»æ»šåŠ¨:${upCount + downCount}` : 
                     `â†“ ä¸‹æ»šåŠ¨ - æ€»æ»šåŠ¨:${upCount + downCount}`, 
           dir < 0 ? 'up' : 'down');
    
    // æ›´æ–°çŠ¶æ€
    lastDir = dir;
    lastTime = now;
  }, { passive: false });

  // æ¸…ç©ºæ—¥å¿—
  function clearLog() {
    logContent.innerHTML = '';
    addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
  }

  // é‡ç½®æµ‹è¯•
  function resetTest() {
    upCount = downCount = reverseCount = 0;
    lastDir = lastTime = null;
    maxHz = 0;
    scrollTimes = [];
    lineScrollSamples = [];
    isLineTestActive = false;
    
    upEl.textContent = '0';
    downEl.textContent = '0';
    reverseEl.textContent = '0';
    maxHzEl.textContent = '0';
    
    // é‡ç½®æ¿€æ´»çŠ¶æ€
    lineTestCard.classList.remove('active');
    hintText.textContent = 'ğŸ–±ï¸ é¼ æ ‡ç§»å…¥æ­¤åŒºåŸŸå¼€å§‹æµ‹è¯•';
    
    clearLog();
    initScrollBox();
    updateStats();
    
    // é‡ç½®è¡Œæ•°åˆ†ææ˜¾ç¤º
    lineAnalysis.innerHTML = 'ç­‰å¾…æµ‹è¯•å¼€å§‹...';
    
    addLog('æ‰€æœ‰æµ‹è¯•å·²é‡ç½®', 'info');
  }

  // å¯¼å‡ºæ•°æ®
  function exportData() {
    const data = {
      timestamp: new Date().toISOString(),
      measurementBaseline: {
        fontSize: FONT_SIZE,
        lineHeight: LINE_HEIGHT,
        lineHeightRatio: LINE_HEIGHT_RATIO
      },
      basicTest: {
        upCount,
        downCount,
        reverseCount,
        maxHz
      },
      lineTest: {
        samples: lineScrollSamples,
        average: lineScrollSamples.length > 0 ? 
          lineScrollSamples.reduce((a, b) => a + b, 0) / lineScrollSamples.length : 0,
        min: lineScrollSamples.length > 0 ? Math.min(...lineScrollSamples) : 0,
        max: lineScrollSamples.length > 0 ? Math.max(...lineScrollSamples) : 0,
        estimatedSystemPixelsPerScroll: lineScrollSamples.length > 0 ?
          (lineScrollSamples.reduce((a, b) => a + b, 0) / lineScrollSamples.length) * LINE_HEIGHT : 0
      },
      scrollTimes: scrollTimes,
      note: `æµ‹é‡åŸºå‡†ï¼šå›ºå®šè¡Œé«˜${LINE_HEIGHT}pxï¼ˆ${FONT_SIZE}pxå­—ä½“ Ã— ${LINE_HEIGHT_RATIO}å€è¡Œé«˜ï¼‰`
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mouse-wheel-test-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    addLog('æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶', 'info');
  }

  // åˆå§‹åŒ–
  window.addEventListener('load', function() {
    initScrollBox();
    updateStats();
    addLog('é¼ æ ‡æ»šè½®æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'info');
    addLog(`æµ‹é‡åŸºå‡†ï¼šå›ºå®šè¡Œé«˜${LINE_HEIGHT}pxï¼ˆ${FONT_SIZE}pxå­—ä½“ Ã— ${LINE_HEIGHT_RATIO}å€è¡Œé«˜ï¼‰`, 'info');
    addLog('ç³»ç»Ÿå‘é€çš„å®é™…åƒç´ å€¼å¯èƒ½å› DPIç¼©æ”¾è€Œå¼‚', 'info');
  });
</script>
</body>
</html>